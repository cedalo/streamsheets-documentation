"use strict";(self.webpackChunkstreamsheets=self.webpackChunkstreamsheets||[]).push([[49324],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),d=i,k=c["".concat(s,".").concat(d)]||c[d]||m[d]||o;return n?a.createElement(k,r(r({ref:t},u),{},{components:n})):a.createElement(k,r({ref:t},u))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},41714:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>f,contentTitle:()=>d,default:()=>N,frontMatter:()=>c,metadata:()=>k,toc:()=>g});var a=n(3905),i=Object.defineProperty,o=Object.defineProperties,r=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,u=(e,t,n)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,m=(e,t)=>{for(var n in t||(t={}))s.call(t,n)&&u(e,n,t[n]);if(l)for(var n of l(t))p.call(t,n)&&u(e,n,t[n]);return e};const c={id:"high-availability-openshift",title:"Openshift High Availability",sidebar_label:"High Availability"},d=void 0,k={unversionedId:"deployment/on-premises/deployment/installation/openshift/high-availability-openshift",id:"version-3.1/deployment/on-premises/deployment/installation/openshift/high-availability-openshift",title:"Openshift High Availability",description:"This setup will deploy HA Mosquitto broker and Platform portal on a managed openshift cluster using Helm charts. To deploy this setup, you'll first need a  running Openshift cluster. This setup has been tested on Open source Openshift OKD cluster. Openshift offers lot of different features on top of Kubernetes. For details on Openshift and OKD you can refer to the Introduction page. For deploying a full fledged OKD cluster,  you can follow the official Openshift OKD installation documentation.  OKD can be mainly installed in two different fashion:",source:"@site/mosquitto_versioned_docs/version-3.1/deployment/on-premises/deployment/installation/openshift/high-availability-openshift.md",sourceDirName:"deployment/on-premises/deployment/installation/openshift",slug:"/deployment/on-premises/deployment/installation/openshift/high-availability-openshift",permalink:"/mosquitto/deployment/on-premises/deployment/installation/openshift/high-availability-openshift",draft:!1,tags:[],version:"3.1",frontMatter:{id:"high-availability-openshift",title:"Openshift High Availability",sidebar_label:"High Availability"},sidebar:"someSidebar",previous:{title:"Single Node",permalink:"/mosquitto/deployment/on-premises/deployment/installation/openshift/single-node-openshift"},next:{title:"Basic Configurations On-Premises Broker",permalink:"/mosquitto/deployment/on-premises/deployment/administrating/configuring-on-premises"}},f={},g=[{value:"HAProxy Configuration",id:"haproxy-configuration",level:2},{value:"Dynamic Backend Configuration",id:"dynamic-backend-configuration",level:3},{value:"Key Configuration Parameters",id:"key-configuration-parameters",level:3},{value:"Openshift Cluster Setup and Configuration",id:"openshift-cluster-setup-and-configuration",level:2},{value:"Dependencies and Prerequisites",id:"dependencies-and-prerequisites",level:3},{value:"Installation",id:"installation",level:2},{value:"Installation using helm charts",id:"installation-using-helm-charts",level:2},{value:"Advanced Configuration",id:"advanced-configuration",level:2},{value:"Configurable Mosquitto Broker Settings",id:"configurable-mosquitto-broker-settings",level:3},{value:"<strong>Mosquitto Configuration Options</strong>",id:"mosquitto-configuration-options",level:4},{value:"<strong>Plugin Configuration</strong>",id:"plugin-configuration",level:4},{value:"<strong>HAProxy Configuration</strong>",id:"haproxy-configuration-1",level:4},{value:"<strong>Complete Example with Custom Configuration</strong>",id:"complete-example-with-custom-configuration",level:4},{value:"<strong>Updating Configuration After Installation</strong>",id:"updating-configuration-after-installation",level:4},{value:"Prometheus Monitoring Integration",id:"prometheus-monitoring-integration",level:3},{value:"<strong>Prerequisites</strong>",id:"prerequisites",level:4},{value:"<strong>Configuration Options</strong>",id:"configuration-options",level:4},{value:"<strong>Verifying Prometheus Integration</strong>",id:"verifying-prometheus-integration",level:4},{value:"<strong>Troubleshooting</strong>",id:"troubleshooting",level:4},{value:"Scaling the Cluster",id:"scaling-the-cluster",level:3},{value:"<strong>Add Nodes</strong>",id:"add-nodes",level:4},{value:"<strong>Remove Nodes</strong>",id:"remove-nodes",level:4},{value:"NetworkPolicy Security (Optional)",id:"networkpolicy-security-optional",level:2},{value:"Prerequisites",id:"prerequisites-1",level:3},{value:"Enable NetworkPolicies",id:"enable-networkpolicies",level:3},{value:"DNS Configuration (Configurable)",id:"dns-configuration-configurable",level:3},{value:"Default Configuration (OpenShift)",id:"default-configuration-openshift",level:4},{value:"Custom DNS Configuration",id:"custom-dns-configuration",level:4},{value:"Detect DNS Configuration",id:"detect-dns-configuration",level:4},{value:"What NetworkPolicies Control",id:"what-networkpolicies-control",level:3},{value:"Create-Cluster Job Support",id:"create-cluster-job-support",level:3},{value:"Verification",id:"verification",level:3},{value:"Important Notes",id:"important-notes",level:3},{value:"Connect to cluster",id:"connect-to-cluster",level:2}],h={toc:g};function N(e){var t,i=e,{components:u}=i,c=((e,t)=>{var n={};for(var a in e)s.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&l)for(var a of l(e))t.indexOf(a)<0&&p.call(e,a)&&(n[a]=e[a]);return n})(i,["components"]);return(0,a.kt)("wrapper",(t=m(m({},h),c),o(t,r({components:u,mdxType:"MDXLayout"}))),(0,a.kt)("p",null,"This setup will deploy HA Mosquitto broker and Platform portal on a managed openshift cluster using Helm charts. To deploy this setup, you'll first need a  running Openshift cluster. This setup has been tested on Open source Openshift OKD cluster. Openshift offers lot of different features on top of Kubernetes. For details on Openshift and OKD you can refer to the Introduction page. For deploying a full fledged OKD cluster,  you can follow the official Openshift OKD installation ",(0,a.kt)("a",m({parentName:"p"},{href:"https://docs.okd.io/"}),"documentation"),".  OKD can be mainly installed in two different fashion:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"IPI: Installer Provisioned Infrastructure"),(0,a.kt)("li",{parentName:"ol"},"UPI: User Provisioned Infrastructure")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Installer Provisioned Infrastructure:"),"  Installer Provisioned Infrastructure (IPI) in OKD/OpenShift refers to a deployment model where the installation program provisions and manages all the components of the infrastructure needed to run the OpenShift cluster. This includes the creation of virtual machines, networking rules, load balancers, and storage components, among others. The installer uses cloud-specific APIs to automatically set up the infrastructure, making the process faster, more standardized, and less prone to human error compared to manually setting up the environment."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"User Provisioned Infrastructure:"),"  User Provisioned Infrastructure (UPI) in OKD/OpenShift is a deployment model where users manually create and manage all the infrastructure components required to run the OpenShift cluster. This includes setting up virtual machines or physical servers, configuring networking, load balancers, storage, and any other necessary infrastructure components. Unlike the Installer Provisioned Infrastructure (IPI) model, where the installation program automatically creates and configures the infrastructure, UPI offers users complete control over the deployment process."),(0,a.kt)("p",null,"You are free to choose your own method among the two. You can also choose the cloud provider you want to deploy your solution on. Openshift OKD supports number of different cloud providers and also gives you an option to do bare-metal installation. In this deployment we went forward with UPI and deployed our infrastructure on Google Cloud Platform (GCP) using the ",(0,a.kt)("inlineCode",{parentName:"p"},"Private cluster")," method mentioned ",(0,a.kt)("a",m({parentName:"p"},{href:"https://docs.okd.io/latest/installing/installing_gcp/installing-gcp-private.html"}),"here"),". Therefore, this solution is developed and tested on GCP, however it is unlikely that basic infrastructure would differ across different cloud providers."),(0,a.kt)("p",null,"A ",(0,a.kt)("inlineCode",{parentName:"p"},"private cluster")," in GCP ensures that the nodes are isolated in a private network, reducing exposure to the public internet but again you are free to choose your own version of infrastructure supported by Openshift OKD.  We will briefly discuss how the infrastructure looks like in our case so that you can have a reference for your own infrastructure."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"OKD Infrastructure (During provisioning)",src:n(9585).Z,title:"OKD Infrastructure on GCP during provisioning",width:"751",height:"510"})),(0,a.kt)("p",null,"Figure 1: OKD Infrastructure on GCP during provisioning"),(0,a.kt)("p",null,"The diagram depicts the deployment process for our OCP cluster on GCP, starting with the establishment of a bastion host. Bastion host is where we'll execute commands to configure the bootstrap node, then the Master nodes, and finally, the worker nodes in a separate subnet. Before initiating the bootstrap procedure, we set up the essential infrastructure components, including networks, subnetworks, an IAM service account, an IAM project, a Private DNS zone, Load balancers, Cloud NATs, and a Cloud Router."),(0,a.kt)("p",null,"Upon completing the bootstrap phase, we dismantled the bootstrap components from the cluster. Subsequently, we focussed on creating the worker nodes. After the worker nodes are operational, we set up a reverse proxy on the bastion host to facilitate local access to the OCP Console UI through our browser. To conclude, we confirm that all cluster operators are marked as \u2018Available\u2019. Once we done with the provisioning the architecture would look something like Figure 2. More detailed steps can be found in the official documentation.  These discussed steps are all part of the official  ",(0,a.kt)("a",m({parentName:"p"},{href:"https://docs.okd.io/latest/installing/installing_gcp/installing-gcp-private.html"}),"documentation"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"OKD Infrastructure (Post provisioning)",src:n(99988).Z,title:"OKD Infrastructure on GCP post provisioning ",width:"684",height:"676"})),(0,a.kt)("p",null,"Figure 2: OKD Infrastructure on GCP post provisioning"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Note:")," This deployment involves setting up a private cluster, which means access to the cluster is limited to through the bastion host. Consequently, we avoid using public DNS for this installation, relying solely on a private DNS zone. To facilitate access to the external UI, we will employ a reverse proxy for this purpose."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HA-PROXY Configurations"),"\nHA-proxy need to be configured accordingly for the kubernetes setup. For server m1, m2 and m3 needs to be configured in this case. Instead of using docker IP we would use DNS names to address the pods. For eg\n",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto-0.mosquitto.ha.svc.cluster.local"),". Here ",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto-0"),",",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto-1"),",",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto-2")," are the name of individual mosquitto pods running as statefulsets. Each new pod would increase its pod-ordinal by 1. Rest can be defined as follows\n",(0,a.kt)("inlineCode",{parentName:"p"},"<pod-name>.<name-of-the-statefulset>.<namespace>.svc.cluster.local")),(0,a.kt)("h2",m({},{id:"haproxy-configuration"}),"HAProxy Configuration"),(0,a.kt)("p",null,"HAProxy acts as a load balancer in front of the Mosquitto cluster, providing a single entry point for MQTT clients while distributing connections across all broker replicas."),(0,a.kt)("h3",m({},{id:"dynamic-backend-configuration"}),"Dynamic Backend Configuration"),(0,a.kt)("p",null,"HAProxy uses Kubernetes DNS to discover and connect to Mosquitto broker pods. Each StatefulSet pod has a predictable DNS name:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-0.mosquitto.<namespace>.svc.cluster.local")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-1.mosquitto.<namespace>.svc.cluster.local")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-2.mosquitto.<namespace>.svc.cluster.local")),(0,a.kt)("li",{parentName:"ul"},"etc.")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"IMPORTANT"),": The Helm chart automatically generates HAProxy backend server entries based on your ",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto.replicas")," setting. You don't need to manually configure individual servers."),(0,a.kt)("h3",m({},{id:"key-configuration-parameters"}),"Key Configuration Parameters"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto.replicas"),": Number of broker replicas (default: 3) - HAProxy automatically configures backends for all replicas"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"nameserver"),": DNS server IP for HAProxy DNS resolution (required for HA)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"haproxy.replicas"),": Number of HAProxy replicas for redundancy (default: 3)")),(0,a.kt)("h2",m({},{id:"openshift-cluster-setup-and-configuration"}),"Openshift Cluster Setup and Configuration"),(0,a.kt)("h3",m({},{id:"dependencies-and-prerequisites"}),"Dependencies and Prerequisites"),(0,a.kt)("p",null,"As we chose to use a private cluster, therefore master and worker nodes would not have access to the internet. Therefore, we will install the dependencies on the bastion node and would also deploy the application from the bastion node."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Prerequisites")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Running Openshift cluster by following the official documentation guide of ",(0,a.kt)("a",m({parentName:"li"},{href:"https://docs.okd.io/"}),"Openshift"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Create a namespace")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Once you are connected to your Openshift setup and can access the cluster using ",(0,a.kt)("inlineCode",{parentName:"li"},"oc")," tool. Create a namespace in which you would want to deploy the application. The deployment folder is pre-configured for the namespace named ",(0,a.kt)("inlineCode",{parentName:"li"},"ha"),". If you want to use the default configuration you can create a namespace named ",(0,a.kt)("inlineCode",{parentName:"li"},"ha")," using the below command:"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"oc create namespace ha")),(0,a.kt)("li",{parentName:"ul"},"If you want to use a different namespace, use the command: ",(0,a.kt)("inlineCode",{parentName:"li"},"oc create namespace <your-custom-namespace>"),".  Replace ",(0,a.kt)("inlineCode",{parentName:"li"},"<your-custom-namespace>")," with the name of the namespace you want to configure.")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"On your bastion node"),": Check the allocated user id for your namespace after you already created your desired namespace (step 2). You can check the allocated user id for your namespace by running the command ",(0,a.kt)("inlineCode",{parentName:"p"},"oc describe namespace <namespace>")," where ",(0,a.kt)("inlineCode",{parentName:"p"},"<namespace>")," is the namespace you chose while creating the namespace in step 2. For default namespace i.e ",(0,a.kt)("inlineCode",{parentName:"p"},"ha"),", the command would be ",(0,a.kt)("inlineCode",{parentName:"p"},"oc describe namespace multinode"),"."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"The above command would output a response.  A sample output could be like:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{}),"      Name:         ha\n      Labels:       kubernetes.io/metadata.name=multinode\n                    pod-security.kubernetes.io/audit=restricted\n                    pod-security.kubernetes.io/audit-version=v1.24\n                    pod-security.kubernetes.io/warn=restricted\n                    pod-security.kubernetes.io/warn-version=v1.24\n      Annotations:  openshift.io/sa.scc.mcs: s0:c27,c4\n                    openshift.io/sa.scc.supplemental-groups: 1000710000/10000\n                    openshift.io/sa.scc.uid-range: 1000710000/10000\n      Status:       Active\n\n      No resource quota.\n      No LimitRange resource.\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Note down the value for ",(0,a.kt)("inlineCode",{parentName:"p"},"openshift.io/sa.scc.uid-range"),". The noted user id will now be used to install the helm chart. This user id needs to be propagated to the pods so that they could have adequate permissions while execution without needing additional security policy. After checking the environment prerequisites are set, follow we will prepare the Mosquitto environment:"))),(0,a.kt)("h2",m({},{id:"installation"}),"Installation"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Prerequisites"),":"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Openshift  Cluster should be up and running."),(0,a.kt)("li",{parentName:"ol"},"You have successfully created the namespace and noted down the uid range.")),(0,a.kt)("h2",m({},{id:"installation-using-helm-charts"}),"Installation using helm charts"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Get the helm chart")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Make sure you have the helm chart  ",(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-3.1-platform-3.1-openshift-cluster.tgz")," downloaded from the Platform portal. In this case, we have the helm chart on our Bastion node. It could differ based on the infrastructure."))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Install Helm Chart:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Use the following ",(0,a.kt)("inlineCode",{parentName:"p"},"helm install")," command to deploy the Mosquitto application on to your OpenShift cluster. Replace ",(0,a.kt)("inlineCode",{parentName:"p"},"<release-name>")," with the desired name for your Helm release and ",(0,a.kt)("inlineCode",{parentName:"p"},"<namespace>")," with your chosen OpenShift namespace:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm install <release-name> mosquitto-3.1-platform-3.1-openshift-cluster.tgz -n <namespace> \\\n  --set mosquitto.securityContext.runAsUser=<namespace-alloted-user-id> \\\n  --set platform.securityContext.runAsUser=<namespace-alloted-user-id> \\\n  --set init.securityContext.runAsUser=<namespace-alloted-userid> \\\n  --set nameserver=<nameserver-ip>\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Required Parameters:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set licenseKey=<your-license-key>"),": Your Cedalo Mosquitto license key (required)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set nameserver=<dns-server-ip>"),": DNS server IP address for HAProxy DNS resolution (required for HA). Find using ",(0,a.kt)("inlineCode",{parentName:"li"},"oc get svc -n kube-system")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.securityContext.runAsUser=<namespace-alloted-user-id>"),": User ID from ",(0,a.kt)("inlineCode",{parentName:"li"},"oc describe namespace <namespace>")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set platform.securityContext.runAsUser=<namespace-alloted-user-id>"),": User ID from ",(0,a.kt)("inlineCode",{parentName:"li"},"oc describe namespace <namespace>")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set init.securityContext.runAsUser=<namespace-alloted-userid>"),": User ID from ",(0,a.kt)("inlineCode",{parentName:"li"},"oc describe namespace <namespace>")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Common Configuration Options:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set storageClass=<storage-class-name>"),": Storage class for persistent volumes. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"standard-rwo"),". Common values:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"GCP: ",(0,a.kt)("inlineCode",{parentName:"li"},"standard-rwo"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"premium-rwo")),(0,a.kt)("li",{parentName:"ul"},"AWS: ",(0,a.kt)("inlineCode",{parentName:"li"},"gp2"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"gp3"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"io1")),(0,a.kt)("li",{parentName:"ul"},"Azure: ",(0,a.kt)("inlineCode",{parentName:"li"},"managed"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"managed-premium")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.serviceType=<serviceType>"),": Service type for HAProxy LoadBalancer. Options: ",(0,a.kt)("inlineCode",{parentName:"li"},"LoadBalancer")," (default), ",(0,a.kt)("inlineCode",{parentName:"li"},"NodePort"),", or ",(0,a.kt)("inlineCode",{parentName:"li"},"ClusterIP")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set platform.serviceType=<serviceType>"),": Service type for Platform UI. Options: ",(0,a.kt)("inlineCode",{parentName:"li"},"LoadBalancer")," (default), ",(0,a.kt)("inlineCode",{parentName:"li"},"NodePort"),", or ",(0,a.kt)("inlineCode",{parentName:"li"},"ClusterIP")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.pullPolicy=<pullPolicy>"),": Image pull policy. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"Always"),". Options: ",(0,a.kt)("inlineCode",{parentName:"li"},"Always"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"IfNotPresent"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"Never")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set imagePullSecrets[0].name=<secret-name>"),": Image pull secret for private registries. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-pro-secret")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"High Availability Configuration:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.replicas=<replica-count>"),": Number of Mosquitto broker replicas. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"3"),". ",(0,a.kt)("strong",{parentName:"li"},"IMPORTANT"),": Use odd numbers (3, 5, 7) for Raft consensus"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.replicas=<replica-count>"),": Number of HAProxy replicas for redundancy. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"3")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.listener=<port>"),": HAProxy MQTT listener port. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.secureListener=<port>"),": HAProxy secure MQTT listener port (if TLS enabled). Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8883")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Storage Configuration:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.persistentStorageCapacity=<size>"),": Storage size for Mosquitto data per instance. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1Gi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set platform.persistentStorageCapacity=<size>"),": Storage size for Platform data. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1Gi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set platform.persistentLogStorageCapacity=<size>"),": Storage size for Platform logs. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1Gi")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Resource Configuration:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.resources.requests.cpu=<cpu>"),": Mosquitto CPU request per instance. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"200m")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.resources.requests.memory=<memory>"),": Mosquitto memory request per instance. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"512Mi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.requests.cpu=<cpu>"),": HAProxy CPU request. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"100m")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.requests.memory=<memory>"),": HAProxy memory request. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"256Mi")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Sample Installation Command:")),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm install sample-release mosquitto-3.1-platform-3.1-openshift-cluster.tgz -n ha \\\n  --set licenseKey=<your-license-key> \\\n  --set nameserver=10.96.10.0 \\\n  --set mosquitto.securityContext.runAsUser=1000710000 \\\n  --set platform.securityContext.runAsUser=1000710000 \\\n  --set init.securityContext.runAsUser=1000710000 \\\n  --set storageClass=standard-rwo \\\n  --set mosquitto.replicas=3 \\\n  --set haproxy.serviceType=LoadBalancer \\\n  --set platform.serviceType=LoadBalancer\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Note:")," You can explore further configuration options in ",(0,a.kt)("inlineCode",{parentName:"p"},"values.yaml"))))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"You can monitor the running pods using the ",(0,a.kt)("inlineCode",{parentName:"p"},"oc get pods -o wide -n <namespace>")," command. To observe the service endpoints ports use ",(0,a.kt)("inlineCode",{parentName:"p"},"oc get svc -n <namespace>"),".")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The default type of cluster would a HA cluster.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"To uninstall the setup:\n",(0,a.kt)("inlineCode",{parentName:"p"},"helm uninstall <release-name> -n <namespace>")))),(0,a.kt)("p",null,"Your Mosquitto setup is now running  with three single mosquitto nodes in a Dynsec cluster along with a Platform portal."),(0,a.kt)("h2",m({},{id:"advanced-configuration"}),"Advanced Configuration"),(0,a.kt)("h3",m({},{id:"configurable-mosquitto-broker-settings"}),"Configurable Mosquitto Broker Settings"),(0,a.kt)("p",null,"The Helm chart provides extensive configuration options for the Mosquitto broker through ",(0,a.kt)("inlineCode",{parentName:"p"},"values.yaml"),". You can customize various aspects of the broker behavior without manually editing configuration files."),(0,a.kt)("h4",m({},{id:"mosquitto-configuration-options"}),(0,a.kt)("strong",{parentName:"h4"},"Mosquitto Configuration Options")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Basic Configuration:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.allowAnonymous=<true|false>"),": Allow unauthenticated access. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"true")," (for HA)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.enableTls=<true|false>"),": Enable TLS listener. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.enableWebsockets=<true|false>"),": Enable websockets listener. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.websocketsPort=<port>"),": Websockets listener port. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8080")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.persistenceLocation=<path>"),": Location for persistent data. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},'"/mosquitto/data/"'))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Performance Tuning:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.maxKeepalive=<seconds>"),": Maximum keepalive value. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1800")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.maxPacketSize=<bytes>"),": Maximum packet size in bytes. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"100000000")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.tcpNodelay=<true|false>"),": Reduce network latency. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"true"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Queue Management:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.maxInflightMessages=<number>"),": Maximum inflight messages per client. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"100")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.maxQueuedMessages=<number>"),": Maximum queued messages per client. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1000"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Control and Logging:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.enableControlApi=<true|false>"),": Enable broker control API. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"true"))),(0,a.kt)("h4",m({},{id:"plugin-configuration"}),(0,a.kt)("strong",{parentName:"h4"},"Plugin Configuration")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Authentication and Security:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.dynamicSecurity.enabled=<true|false>"),": Enable dynamic security plugin. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")," (for HA)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.ldap.enabled=<true|false>"),": Enable LDAP authentication. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.jwt.enabled=<true|false>"),": Enable JWT authentication. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Persistence:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.persistence.sqlite.enabled=<true|false>"),": Enable SQLite persistence. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")," (for HA)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.persistence.lmdb.enabled=<true|false>"),": Enable LMDB persistence. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Bridge Plugins:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.httpBridge.enabled=<true|false>"),": Enable HTTP bridge plugin. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.mongodbBridge.enabled=<true|false>"),": Enable MongoDB bridge plugin. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.kafkaBridge.enabled=<true|false>"),": Enable Kafka bridge plugin. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.sqlBridge.enabled=<true|false>"),": Enable SQL bridge plugin. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.influxdbBridge.enabled=<true|false>"),": Enable InfluxDB bridge plugin. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Metrics and Monitoring:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.prometheusMetrics.enabled=<true|false>"),": Enable Prometheus metrics plugin. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.prometheusMetrics.port=<port>"),": Prometheus metrics port. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8000")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.prometheusMetrics.updateInterval=<seconds>"),": Update interval. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"15")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.influxdbMetrics.enabled=<true|false>"),": Enable InfluxDB metrics plugin. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false"))),(0,a.kt)("h4",m({},{id:"haproxy-configuration-1"}),(0,a.kt)("strong",{parentName:"h4"},"HAProxy Configuration")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Basic HAProxy Settings:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.replicas=<count>"),": Number of HAProxy replicas for redundancy. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"3")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.serviceType=<type>"),": Service type for HAProxy. Options: ",(0,a.kt)("inlineCode",{parentName:"li"},"LoadBalancer")," (default), ",(0,a.kt)("inlineCode",{parentName:"li"},"NodePort"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"ClusterIP")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.pullPolicy=<policy>"),": Image pull policy for HAProxy. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"Always"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HAProxy Port Configuration:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.listener=<port>"),": MQTT listener port (non-TLS). Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.listenerTarget=<port>"),": Target port on HAProxy container. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.secureListener=<port>"),": MQTT secure listener port (TLS). Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.secureListenerTarget=<port>"),": Target port for secure connection. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.stats=<port>"),": HAProxy statistics page port. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8404"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HAProxy Performance Configuration:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.maxconn=<number>"),": Maximum concurrent connections per HAProxy instance. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"10000"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HAProxy Resource Configuration:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.requests.cpu=<cpu>"),": HAProxy CPU request. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"100m")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.requests.memory=<memory>"),": HAProxy memory request. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"256Mi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.limits.cpu=<cpu>"),": HAProxy CPU limit. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"500m")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.limits.memory=<memory>"),": HAProxy memory limit. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"512Mi"))),(0,a.kt)("h4",m({},{id:"complete-example-with-custom-configuration"}),(0,a.kt)("strong",{parentName:"h4"},"Complete Example with Custom Configuration")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm install custom-ha-mosquitto mosquitto-3.1-platform-3.1-openshift-cluster.tgz -n ha \\\n  --set licenseKey=<your-license-key> \\\n  --set nameserver=10.96.10.0 \\\n  --set mosquitto.securityContext.runAsUser=1000710000 \\\n  --set platform.securityContext.runAsUser=1000710000 \\\n  --set init.securityContext.runAsUser=1000710000 \\\n  --set storageClass=standard-rwo \\\n  --set mosquitto.replicas=5 \\\n  --set haproxy.replicas=2 \\\n  --set haproxy.serviceType=LoadBalancer \\\n  --set platform.serviceType=LoadBalancer \\\n  --set mosquitto.config.enableTls=true \\\n  --set mosquitto.config.enableWebsockets=true \\\n  --set mosquitto.config.plugins.prometheusMetrics.enabled=true \\\n  --set mosquitto.config.plugins.prometheusMetrics.port=8000 \\\n  --set mosquitto.resources.requests.cpu=300m \\\n  --set mosquitto.resources.requests.memory=1Gi\n")),(0,a.kt)("h4",m({},{id:"updating-configuration-after-installation"}),(0,a.kt)("strong",{parentName:"h4"},"Updating Configuration After Installation")),(0,a.kt)("p",null,"To update your Mosquitto configuration after installation:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Using Helm Upgrade:")),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm upgrade <release-name> mosquitto-3.1-platform-3.1-openshift-cluster.tgz -n <namespace> \\\n  --set mosquitto.config.enableTls=true \\\n  --set mosquitto.config.plugins.prometheusMetrics.enabled=true \\\n  --set mosquitto.replicas=5\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Verify Configuration:")),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),'# Check if pods are restarting with new configuration\noc get pods -n <namespace> -w\n\n# Verify configuration in running pod\noc exec -it <mosquitto-pod> -n <namespace> -- cat /mosquitto/config/mosquitto.conf\n\n# Check HAProxy configuration\noc get configmap haproxyconfig -n <namespace> -o yaml | grep "server m"\n')))),(0,a.kt)("h3",m({},{id:"prometheus-monitoring-integration"}),"Prometheus Monitoring Integration"),(0,a.kt)("h4",m({},{id:"prerequisites"}),(0,a.kt)("strong",{parentName:"h4"},"Prerequisites")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Prometheus Operator"),": Your cluster must have Prometheus Operator installed"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"ServiceMonitor CRD"),": Verify with ",(0,a.kt)("inlineCode",{parentName:"li"},"oc get crd servicemonitors.monitoring.coreos.com"))),(0,a.kt)("h4",m({},{id:"configuration-options"}),(0,a.kt)("strong",{parentName:"h4"},"Configuration Options")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Enable Prometheus Monitoring:")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm install <release-name> mosquitto-3.1-platform-3.1-openshift-cluster.tgz -n <namespace> \\\n  --set licenseKey=<your-license-key> \\\n  --set nameserver=<nameserver-ip> \\\n  --set mosquitto.securityContext.runAsUser=<user-id> \\\n  --set platform.securityContext.runAsUser=<user-id> \\\n  --set init.securityContext.runAsUser=<user-id> \\\n  --set prometheus.enabled=true \\\n  --set mosquitto.config.plugins.prometheusMetrics.enabled=true \\\n  --set mosquitto.config.plugins.prometheusMetrics.port=8000\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Key Configuration Parameters:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set prometheus.enabled=true"),": Enable Prometheus monitoring"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set prometheus.serviceMonitor.enabled=true"),": Create ServiceMonitor resource"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set prometheus.serviceMonitor.interval=<interval>"),": Scrape interval (default: ",(0,a.kt)("inlineCode",{parentName:"li"},"30s"),")"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set prometheus.serviceMonitor.scrapeTimeout=<timeout>"),": Scrape timeout (default: ",(0,a.kt)("inlineCode",{parentName:"li"},"10s"),")"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.prometheusMetrics.enabled=true"),": Enable metrics plugin"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.prometheusMetrics.port=<port>"),": Metrics port (default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8000"),")")),(0,a.kt)("h4",m({},{id:"verifying-prometheus-integration"}),(0,a.kt)("strong",{parentName:"h4"},"Verifying Prometheus Integration")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"# Check ServiceMonitor is created\noc get servicemonitor -n <namespace>\n\n# Check metrics endpoint\noc port-forward svc/mosquitto-0 8000:8000 -n <namespace>\ncurl http://localhost:8000/metrics\n")),(0,a.kt)("h4",m({},{id:"troubleshooting"}),(0,a.kt)("strong",{parentName:"h4"},"Troubleshooting")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"ServiceMonitor not found"),": Ensure Prometheus Operator is running and has RBAC permissions"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"No metrics"),": Verify ",(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto.config.plugins.prometheusMetrics.enabled=true")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Connection refused"),": Check if metrics port is exposed in service")),(0,a.kt)("p",null,"Access the metrics endpoint at: ",(0,a.kt)("inlineCode",{parentName:"p"},"http://<mosquitto-service>:8000/metrics")),(0,a.kt)("h3",m({},{id:"scaling-the-cluster"}),"Scaling the Cluster"),(0,a.kt)("h4",m({},{id:"add-nodes"}),(0,a.kt)("strong",{parentName:"h4"},"Add Nodes")),(0,a.kt)("p",null,"If you want to add more nodes to the existing cluster, the process is now simplified with dynamic HAProxy configuration."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"IMPORTANT"),": The Helm chart now ",(0,a.kt)("strong",{parentName:"p"},"automatically generates HAProxy server entries")," based on the ",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto.replicas")," value. You no longer need to manually edit the HAProxy configuration!"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Simple Scaling Process:")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Scale the Mosquitto StatefulSet to your desired replica count:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"oc scale statefulsets mosquitto --replicas=5 -n <namespace>\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Update the Helm values to match the new replica count:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm upgrade <release-name> mosquitto-3.1-platform-3.1-openshift-cluster.tgz -n <namespace> \\\n  --set mosquitto.replicas=5 \\\n  --set mosquitto.securityContext.runAsUser=<namespace-alloted-user-id> \\\n  --set platform.securityContext.runAsUser=<namespace-alloted-user-id> \\\n  --set init.securityContext.runAsUser=<namespace-alloted-userid> \\\n  --set nameserver=<nameserver-ip>\n")),(0,a.kt)("p",{parentName:"li"},"This will:"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Automatically update HAProxy ConfigMap with all 5 server entries"),(0,a.kt)("li",{parentName:"ul"},"Update the cluster setup job to include the new brokers"),(0,a.kt)("li",{parentName:"ul"},"Restart HAProxy pods with the new configuration"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Verify HAProxy configuration:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),'oc get configmap haproxyconfig -n <namespace> -o yaml | grep "server m"\n')))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Adding Nodes to Platform Portal:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Navigate to ",(0,a.kt)("inlineCode",{parentName:"li"},"Connections")," section on Platform portal and click ",(0,a.kt)("inlineCode",{parentName:"li"},"Edit")),(0,a.kt)("li",{parentName:"ul"},"Click ",(0,a.kt)("inlineCode",{parentName:"li"},"Add Node")),(0,a.kt)("li",{parentName:"ul"},"Fill in the details:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"NAME"),": name of the connection (you can choose your own name)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"URL"),": ",(0,a.kt)("inlineCode",{parentName:"li"},"mqtt://mosquitto-x.mosquitto.<namespace>.svc.cluster.local:1885"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Replace ",(0,a.kt)("inlineCode",{parentName:"li"},"x")," with the pod ordinal (0, 1, 2, 3, 4, etc.)"),(0,a.kt)("li",{parentName:"ul"},"Replace ",(0,a.kt)("inlineCode",{parentName:"li"},"<namespace>")," with your actual namespace"))))),(0,a.kt)("li",{parentName:"ul"},"Add your username and password, select/deselect further options"),(0,a.kt)("li",{parentName:"ul"},"Select ",(0,a.kt)("inlineCode",{parentName:"li"},"Test Connection")," to verify your connection"),(0,a.kt)("li",{parentName:"ul"},"Click ",(0,a.kt)("inlineCode",{parentName:"li"},"Save")," to save the connection"),(0,a.kt)("li",{parentName:"ul"},"Click ",(0,a.kt)("inlineCode",{parentName:"li"},"Apply")," to apply the changes to the cluster"),(0,a.kt)("li",{parentName:"ul"},"Wait for the cluster to be updated and monitor progress in the ",(0,a.kt)("inlineCode",{parentName:"li"},"Cluster")," section")),(0,a.kt)("h4",m({},{id:"remove-nodes"}),(0,a.kt)("strong",{parentName:"h4"},"Remove Nodes")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"You can start by removing the node configuration from the existing cluster using the ",(0,a.kt)("inlineCode",{parentName:"li"},"Cluster Node")," section in the Platform portal and delete the additional node. Make sure you maintain at least 3 nodes in the cluster for HA."),(0,a.kt)("li",{parentName:"ul"},"Then you can set the replica count to desired number. For eg if you want to decrease the number of nodes from four nodes to three nodes you can use the following command.",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"oc scale statefulsets mosquitto --replicas=3 -n <namespace>\n")))),(0,a.kt)("h2",m({},{id:"networkpolicy-security-optional"}),"NetworkPolicy Security (Optional)"),(0,a.kt)("p",null,"For enhanced security, you can enable NetworkPolicies to control traffic flow between pods. This restricts network access to only necessary connections."),(0,a.kt)("h3",m({},{id:"prerequisites-1"}),"Prerequisites"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"CNI Plugin"),": Your cluster must support NetworkPolicies (Calico, Cilium, Weave Net, etc.)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"NetworkPolicy Support"),": Verify with ",(0,a.kt)("inlineCode",{parentName:"li"},"oc get crd networkpolicies.networking.k8s.io"))),(0,a.kt)("h3",m({},{id:"enable-networkpolicies"}),"Enable NetworkPolicies"),(0,a.kt)("p",null,"Add the following to your Helm installation:"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"--set networkPolicy.enabled=true\n")),(0,a.kt)("h3",m({},{id:"dns-configuration-configurable"}),"DNS Configuration (Configurable)"),(0,a.kt)("p",null,"NetworkPolicies require DNS resolution to work properly. The Helm chart includes configurable DNS settings that automatically adapt to different cluster environments:"),(0,a.kt)("h4",m({},{id:"default-configuration-openshift"}),"Default Configuration (OpenShift)"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-yaml"}),'networkPolicy:\n  enabled: true\n  dns:\n    namespace: "openshift-dns"\n    podSelector:\n      key: "dns.operator.openshift.io/daemonset-dns"\n      value: "default"\n    ports:\n      udp: 5353\n      tcp: 5353\n')),(0,a.kt)("h4",m({},{id:"custom-dns-configuration"}),"Custom DNS Configuration"),(0,a.kt)("p",null,"For non-standard clusters, you can customize DNS settings:"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm install mosquitto-ha . -n <namespace> \\\n  --set networkPolicy.enabled=true \\\n  --set networkPolicy.dns.namespace=<dns-namespace> \\\n  --set networkPolicy.dns.podSelector.key=<selector-key> \\\n  --set networkPolicy.dns.podSelector.value=<selector-value> \\\n  --set networkPolicy.dns.ports.udp=<dns-udp-port> \\\n  --set networkPolicy.dns.ports.tcp=<dns-tcp-port>\n")),(0,a.kt)("h4",m({},{id:"detect-dns-configuration"}),"Detect DNS Configuration"),(0,a.kt)("p",null,"Use these commands to find your cluster's DNS configuration:"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"# Find DNS namespace\noc get pods --all-namespaces | grep -E 'dns|core-dns'\n\n# Find DNS pod labels\noc get pods -n openshift-dns --show-labels | grep dns\noc get pods -n kube-system --show-labels | grep -E 'dns|coredns'\n\n# Find DNS service ports\noc describe svc dns-default -n openshift-dns | grep -A 5 \"Port:\"\n")),(0,a.kt)("h3",m({},{id:"what-networkpolicies-control"}),"What NetworkPolicies Control"),(0,a.kt)("p",null,"The Helm chart creates 5 NetworkPolicy resources:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"Mosquitto NetworkPolicy"),": Controls MQTT traffic (1888), admin access (1885), Raft communication (7000), and create-cluster job access"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"HAProxy NetworkPolicy"),": Manages external MQTT connections (1883/8883) and backend communication"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"Platform NetworkPolicy"),": Controls web UI access (3000/443) and MQTT operations"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"Cluster Setup NetworkPolicy"),": Allows cluster initialization job to communicate with brokers"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"Image Registry Policy"),": Permits image pulls from ",(0,a.kt)("inlineCode",{parentName:"li"},"registry.cedalo.com"))),(0,a.kt)("h3",m({},{id:"create-cluster-job-support"}),"Create-Cluster Job Support"),(0,a.kt)("p",null,"For high availability deployments, the ",(0,a.kt)("inlineCode",{parentName:"p"},"create-cluster")," job requires specific network access:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Port 1885"),": Admin access to Mosquitto brokers for cluster initialization"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"DNS Resolution"),": Required for service discovery during cluster formation")),(0,a.kt)("p",null,"The Mosquitto NetworkPolicy automatically includes ingress rules for the create-cluster job."),(0,a.kt)("h3",m({},{id:"verification"}),"Verification"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),'# Check NetworkPolicies are created\noc get networkpolicies -n <namespace>\n\n# Test connectivity (should work normally)\noc exec -it <mosquitto-pod> -- mosquitto_pub -h localhost -t test -m "hello"\n\n# Test DNS resolution from platform pod\noc exec -it <platform-pod> -- nslookup mosquitto-0.mosquitto.ha.svc.cluster.local\n\n# Check create-cluster job logs\noc logs -l job-name=create-cluster -n <namespace>\n')),(0,a.kt)("h3",m({},{id:"important-notes"}),"Important Notes"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Default Behavior"),": Without NetworkPolicies, all pods can communicate freely"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"CNI Requirement"),": NetworkPolicies only work with compatible CNI plugins"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"DNS Dependency"),": NetworkPolicies require proper DNS configuration for service discovery"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"OpenShift DNS"),": Uses port 5353 instead of standard port 53"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Troubleshooting"),": If connectivity issues occur, disable with ",(0,a.kt)("inlineCode",{parentName:"li"},"--set networkPolicy.enabled=false"))),(0,a.kt)("p",null,"For detailed NetworkPolicy documentation, see the ",(0,a.kt)("inlineCode",{parentName:"p"},"NETWORK-POLICY.md")," file in the Helm chart directory."),(0,a.kt)("h2",m({},{id:"connect-to-cluster"}),"Connect to cluster"),(0,a.kt)("p",null,"Once your setup is ready, you can access the mosquitto brokers using the external ip of the haproxy service deployed to connect to the cluster from the outside world.\nGo to the ",(0,a.kt)("inlineCode",{parentName:"p"},"Client Account"),' menu and create a new client to connect from. Make sure to assign a role, like the default "client" role, to allow your client to publish and/or subscribe to topics.\nNow you can connect to the Mosquitto cluster. You can access it either with connecting it directly to worker node running the haproxy pod along with a service exposed at port 1883:'),(0,a.kt)("p",null,"To get the external ip of HAproxy service:\n",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl get service haproxy -n <namespace>")),(0,a.kt)("p",null,"In this example command we use Mosquitto Sub to subscribe onto all topics:\n",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto_sub -h <external-ip-of-haproxy> -p 1883 -u <username> -P <password> -t '#'")),(0,a.kt)("p",null,"Make sure to replace your IP, username and password."))}N.isMDXComponent=!0},9585:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/okd-infrastructure-1-bba8c29af6e08db7c6f3e61d79bfd615.png"},99988:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/okd-infrastructure-2-abe5236cfef5147cd3d552b6886cc976.png"}}]);