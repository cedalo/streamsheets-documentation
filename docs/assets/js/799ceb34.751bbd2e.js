"use strict";(self.webpackChunkstreamsheets=self.webpackChunkstreamsheets||[]).push([[98054],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>d});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},m=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,m=i(e,["components","mdxType","originalType","parentName"]),c=u(n),d=o,h=c["".concat(l,".").concat(d)]||c[d]||p[d]||r;return n?a.createElement(h,s(s({ref:t},m),{},{components:n})):a.createElement(h,s({ref:t},m))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,s=new Array(r);s[0]=c;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var u=2;u<r;u++)s[u]=n[u];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},96509:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>k,contentTitle:()=>d,default:()=>f,frontMatter:()=>c,metadata:()=>h,toc:()=>g});var a=n(3905),o=Object.defineProperty,r=Object.defineProperties,s=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,m=(e,t,n)=>t in e?o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,p=(e,t)=>{for(var n in t||(t={}))l.call(t,n)&&m(e,n,t[n]);if(i)for(var n of i(t))u.call(t,n)&&m(e,n,t[n]);return e};const c={id:"high-availability-autoscaling",title:"High Availability Autoscaling",sidebar_label:"High Availability Autoscaling"},d=void 0,h={unversionedId:"kubernetes/high-availability-autoscaling",id:"version-2.7/kubernetes/high-availability-autoscaling",title:"High Availability Autoscaling",description:"To set up a multi-node-HA Mosquitto broker and Management Center with autoscaling using Helm charts, you'll first need a Kubernetes environment. For deploying a full fledged kubernetes cluster on multiple hosts, Kubeadm is an excellent choice. Kubeadm is a command-line tool in the Kubernetes ecosystem designed to facilitate the process of setting up and bootstrapping a Kubernetes cluster.(Discussed in Introduction section).",source:"@site/mosquitto_versioned_docs/version-2.7/kubernetes/high-availability-autoscaling.md",sourceDirName:"kubernetes",slug:"/kubernetes/high-availability-autoscaling",permalink:"/mosquitto/kubernetes/high-availability-autoscaling",draft:!1,tags:[],version:"2.7",frontMatter:{id:"high-availability-autoscaling",title:"High Availability Autoscaling",sidebar_label:"High Availability Autoscaling"},sidebar:"someSidebar",previous:{title:"High Availability",permalink:"/mosquitto/kubernetes/high-availability"},next:{title:"Release Notes",permalink:"/mosquitto/release-notes"}},k={},g=[{value:"Why Auto-scaling ?",id:"why-auto-scaling-",level:3},{value:"How does Auto-scaling works?",id:"how-does-auto-scaling-works",level:3},{value:"Installation",id:"installation",level:2},{value:"Kubernetes Cluster Setup",id:"kubernetes-cluster-setup",level:2},{value:"Dependencies and Prerequisites",id:"dependencies-and-prerequisites",level:3},{value:"Further Useful Commands:",id:"further-useful-commands",level:3},{value:"Usage",id:"usage",level:2}],N={toc:g};function f(e){var t,n=e,{components:o}=n,m=((e,t)=>{var n={};for(var a in e)l.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&i)for(var a of i(e))t.indexOf(a)<0&&u.call(e,a)&&(n[a]=e[a]);return n})(n,["components"]);return(0,a.kt)("wrapper",(t=p(p({},N),m),r(t,s({components:o,mdxType:"MDXLayout"}))),(0,a.kt)("p",null,"To set up a multi-node-HA Mosquitto broker and Management Center with autoscaling using Helm charts, you'll first need a Kubernetes environment. For deploying a full fledged kubernetes cluster on multiple hosts, Kubeadm is an excellent choice. Kubeadm is a command-line tool in the Kubernetes ecosystem designed to facilitate the process of setting up and bootstrapping a Kubernetes cluster.(Discussed in Introduction section).\nThis setup would deploy a 3 Mosquitto broker as a statefulsets. Also, a Management-Center pod and HA-proxy pod as a deployment entity. All the deployment would be deployed on multiple hosts. This deployment by default uses a NFS server to mount volumes. You would need to setup the NFS server before using this deployment."),(0,a.kt)("h3",p({},{id:"why-auto-scaling-"}),"Why Auto-scaling ?"),(0,a.kt)("p",null,"When we deploy the Kubernetes setup using the above procedure, by default we start with 3 Mosquitto Pods, 1 MMC and 1 HA. However, we might run into problems if we have a lot of incoming requests and connections causing overload at Mosquitto brokers, especially in DynSec mode. We would want the setup to adjust based on the load to avoid crashes and maintain system requirements and at the same time avoid any need of human monitoring and intervention."),(0,a.kt)("h3",p({},{id:"how-does-auto-scaling-works"}),"How does Auto-scaling works?"),(0,a.kt)("p",null,"On deploying the above setup we also deploy certain other helper pods that takes care of Auto-scaling. For eg:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Metrics Server:")," This server pod monitors metrics of the deployed applications pods. Metrics could be CPU, Memory etc."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Horizontal Pod Scaler (HPA):")," HPA automatically scales up or down the pods based on the threshold. For eg: If the CPU threshold is set to 60%, and of overall CPU consumption across all pods reaches 60%, HPA scales up the Mosquitto pods."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Cluster-operator:")," This pod keeps tracks of pod scaling and triggers the requests to MQTT APIs so that newly scaled pods gets added to internal cluster of Mosquitto brokers. For eg If the current number of Mosquitto brokers are 3 and it scales to 5, then cluster-operator would send a ",(0,a.kt)("inlineCode",{parentName:"li"},"addNode")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"joinCluster")," MQTT request for 2 added nodes. If pod is to be scaled down, then the cluster-operator would send ",(0,a.kt)("inlineCode",{parentName:"li"},"removeNode")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"leaveCluster")," MQTT API requests.")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Recommended Setup")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"1 Control-plane node, 3 worker nodes and a NFS Server"),(0,a.kt)("li",{parentName:"ol"},"You can name them control-plane, node-1, node-2, node-3, nfs-server. If you want to have different names for your machines you would have to uncompress the helm charts and change the hostnames entries of ",(0,a.kt)("inlineCode",{parentName:"li"},"values.yaml."),(0,a.kt)("inlineCode",{parentName:"li"},"tar -xzvf mosquitto-multi-node-multi-host-autoscale-0.1.0.tgz"),(0,a.kt)("inlineCode",{parentName:"li"},"cd mosquitto-multi-node-multi-host-autoscale"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Change the values of hostname from node-1/node-2/node-3 to the names of your machines."),(0,a.kt)("li",{parentName:"ul"},"Package the helm charts\n",(0,a.kt)("inlineCode",{parentName:"li"},"helm package mosquitto-multi-node-multi-host-autoscale")),(0,a.kt)("li",{parentName:"ul"},"Follow the ",(0,a.kt)("a",p({parentName:"li"},{href:"#installation"}),"installation")," section.")))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HA-PROXY Configurations"),"\nHA-proxy need to be configured accordingly for the kubernetes setup. For eg server m1, m2 and m3 needs to be configured in this case. You would need to configure more server based on your requirements and based on the number mounts you have created on NFS. The autoscaling setup may scale up and down your deployment, so make sure you setup atleast 6 server entries in your ",(0,a.kt)("inlineCode",{parentName:"p"},"haproxy.cfg"),". Instead of using docker IP we would use DNS names to address the pods. For eg\n",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto-0.mosquitto.multinode.svc.cluster.local"),". Here ",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto-0"),",",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto-1"),",",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto-2")," are the name of individual mosquitto pods running as statefulsets. Each new pod would increase its pod-ordinal by 1. Template of the connection endpoints can be defined as follows\n",(0,a.kt)("inlineCode",{parentName:"p"},"<pod-name>.<name-of-the-statefulset>.<namespace>.svc.cluster.local"),"\nIn the below config, we have configured 6 servers:"),(0,a.kt)("pre",null,(0,a.kt)("code",p({parentName:"pre"},{}),"global\n    daemon\n    maxconn 10000\n    resolvers kubernetes\n        nameserver dns1 10.96.0.10:53   # Replace with your Kube DNS IP\n        resolve_retries 3\n        timeout retry 1s\n        hold valid 10s\n\nfrontend mqtt_frontend\n    bind *:1883\n    mode tcp\n    default_backend mqtt_backend\n    timeout client 10m\n\nbackend mqtt_backend\n    timeout connect 5000\n    timeout server 10m\n    mode tcp\n    option redispatch\n    server m1 mosquitto-0.mosquitto.multinode.svc.cluster.local:1883 check resolvers kubernetes on-marked-down shutdown-sessions\n    server m2 mosquitto-1.mosquitto.multinode.svc.cluster.local:1883 check resolvers kubernetes on-marked-down shutdown-sessions\n    server m3 mosquitto-2.mosquitto.multinode.svc.cluster.local:1883 check resolvers kubernetes on-marked-down shutdown-sessions\n    server m4 mosquitto-3.mosquitto.multinode.svc.cluster.local:1883 check resolvers kubernetes on-marked-down shutdown-sessions\n    server m5 mosquitto-4.mosquitto.multinode.svc.cluster.local:1883 check resolvers kubernetes on-marked-down shutdown-sessions\n    server m6 mosquitto-5.mosquitto.multinode.svc.cluster.local:1883 check resolvers kubernetes on-marked-down shutdown-sessions\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"10.96.0.10")," is the Kube-api server IP. We add nameserver so that the HA-proxy do not crash when some of the servers are not available as in autoscaling the pods server may scale up and down."),(0,a.kt)("h2",p({},{id:"installation"}),"Installation"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Prerequisites:")," Kubernetes Cluster should be up and running. If you are yet to setup the cluster, refer Kubernetes Cluster setup section ",(0,a.kt)("a",p({parentName:"p"},{href:"#kubernetes-cluster-setup"}),"Kubernetes Cluster Setup"),".\nOnce kubernetes cluster is up and running and you have installed all the configmaps through ",(0,a.kt)("inlineCode",{parentName:"p"},"setup.sh"),", you can now follow these steps to install the multi-node Mosquitto broker setup:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Setup the folder on your local machine:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"If not done previously, copy or setup the ",(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling")," repository to the NFS server and Control-plane. For both instances the path of the repository has to be the same. Also make sure to create a directory inside the repository on Control-plane named ",(0,a.kt)("inlineCode",{parentName:"li"},"license")," that contains the ",(0,a.kt)("inlineCode",{parentName:"li"},"license.lic")," file we provided you."))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Setup NFS Server")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Install necessary dependencies\n",(0,a.kt)("inlineCode",{parentName:"li"},"sudo apt-get update"),(0,a.kt)("inlineCode",{parentName:"li"},"sudo apt-get install nfs-kernel-server")),(0,a.kt)("li",{parentName:"ul"},"Configure exports directory.Open the ",(0,a.kt)("inlineCode",{parentName:"li"},"/etc/exports")," file on NFS-server. Expose the directories so that pods running on other nodes can access these directories.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"You can use the following as a reference. Here we expose three mosquitto nodes and management center.")))),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",p({parentName:"pre"},{}),"/home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling/server1/mosquitto/data *(rw,sync,no_root_squash,no_subtree_check)\n/home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling/server2/mosquitto/data  *(rw,sync,no_root_squash,no_subtree_check)\n/home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling/server3/mosquitto/data *(rw,sync,no_root_squash,no_subtree_check)\n/home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling/server4/mosquitto/data *(rw,sync,no_root_squash,no_subtree_check)\n/home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling/server5/mosquitto/data *(rw,sync,no_root_squash,no_subtree_check)\n/home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling/server6/mosquitto/data *(rw,sync,no_root_squash,no_subtree_check)\n/home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling/server1/management-center/config *(rw,sync,no_root_squash,no_subtree_check)\n")))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Make sure all the ",(0,a.kt)("inlineCode",{parentName:"li"},"data")," directories have adequate privilges so that mosquitto kubernetes pods can create additional directories inside these ",(0,a.kt)("inlineCode",{parentName:"li"},"data")," directories. If you face any issues like ",(0,a.kt)("inlineCode",{parentName:"li"},"permission denied")," you can try giving the ",(0,a.kt)("inlineCode",{parentName:"li"},"1000")," ownership to all the relevant ",(0,a.kt)("inlineCode",{parentName:"li"},"data")," dir using following command:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",p({parentName:"pre"},{}),"sudo chown -R 1000:1000 /home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes/server1/mosquitto/data\nsudo chown -R 1000:1000 /home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes/server2/mosquitto/data\nsudo chown -R 1000:1000 /home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes/server3/mosquitto/data\n")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Note"),": We provide ownership of ",(0,a.kt)("inlineCode",{parentName:"li"},"1000")," as mosquitto kubernetes pods uses user id of ",(0,a.kt)("inlineCode",{parentName:"li"},"1000")," by default."),(0,a.kt)("li",{parentName:"ul"},"Expose the directories using:\n",(0,a.kt)("inlineCode",{parentName:"li"},"sudo exportfs -a")),(0,a.kt)("li",{parentName:"ul"},"Restart the kernel-server\n",(0,a.kt)("inlineCode",{parentName:"li"},"sudo systemctl restart nfs-kernel-server")),(0,a.kt)("li",{parentName:"ul"},"Install neccessary nfs-common on other nodes so that they act as nfs-clients\n",(0,a.kt)("inlineCode",{parentName:"li"},"sudo apt-get install nfs-common"))))),(0,a.kt)("ol",p({},{start:3}),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Change Directory:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Navigate to the project directory (i.e multi-node-multi-host-autoscaling).\n",(0,a.kt)("inlineCode",{parentName:"li"},"cd mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling/kubernetes/multi-node-multi-host/")))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Install Helm Chart:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Use the following ",(0,a.kt)("inlineCode",{parentName:"li"},"helm install")," command to deploy the setup to your Kubernetes cluster. Replace ",(0,a.kt)("inlineCode",{parentName:"li"},"<release-name>")," with the desired name for your Helm release and ",(0,a.kt)("inlineCode",{parentName:"li"},"<namespace>")," with your chosen Kubernetes namespace:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"helm install <release-name>  mosquitto-multi-node-multi-host-autoscale-0.1.0.tgz  --set repoPath=$HOME -n <namespace>\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"repoPath"),": Set the ",(0,a.kt)("inlineCode",{parentName:"li"},"repoPath")," flag to the path where this repo was cloned. The above command expects it to be at ",(0,a.kt)("inlineCode",{parentName:"li"},"$HOME"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"namespace"),": Set it to the namespace of your deployment."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Note"),": Ensure that you have a running Kubernetes cluster set up to run this deployment. We recommend setting up the kubernetes cluster using Kubeadm. You can also use our installation script to set up Kubernetes cluster. To setup the kubernetes cluster, follow the instructions in Kubernetes Cluster Setup."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Note"),": If you want to deploy the setup in a different namespace, make sure to pass a seperate flag ",(0,a.kt)("inlineCode",{parentName:"li"},"--set namespace=<your-custom-namespace>")," along with the helm installation command"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Note"),": By default the NFS server IP is set to 10.156.0.10 .You can change the NFS server IP by passing ",(0,a.kt)("inlineCode",{parentName:"li"},"--set nfs=<your-nfs-ip>")," by passing it along with helm installation command."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Note"),": By default the HPA threshold is set to 60 . That mean Horizontal Pod Scaler will scale the pods if overall CPU consumption passes the 60% threshold. To set a new thresold, you can change pass ",(0,a.kt)("inlineCode",{parentName:"li"},"--set hpa_threshold=<new_hpa_threshold>")," along with helm installation command."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"Note"),": By default the max pod number is set to 5. That means tha HPA can only scale the max replica pods to 5. If you want set a new higher number, you can set it through NFS server IP is set it by passing ",(0,a.kt)("inlineCode",{parentName:"li"},"--set max_replica=<your-max-replica-count>")," by passing it along with helm installation command. Make sure you have configured the servers in HACONFIG and also exported the data directories on NFS server for new potential pods/servers."),(0,a.kt)("li",{parentName:"ul"},"So for eg: If you NFS IP is 10.10.10.10,your name namespace is ",(0,a.kt)("inlineCode",{parentName:"li"},"test-namespace")," ,your new hpa threshold is 80 and max replica changed to 6 your arbitrary release name is ",(0,a.kt)("inlineCode",{parentName:"li"},"sample-release-name")," then your helm installation command should be:")),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"helm install sample-release-name  mosquitto-multi-node-multi-host-0.1.0.tgz   --set repoPath=$HOME -n test-namespace --set namespace=test-namespace --set nfs=10.10.10.10 --set hpa_threshold=80  --set max_replica=6\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"You can monitor the running pods using the following command:\n",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl get pods -o wide -n <namespace>"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Open Applications"))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"http://localhost:31021")," (MMC)"),(0,a.kt)("li",{parentName:"ul"},"IP: ip-of-host-running-ha-proxy & Port: 31028 (HA)")),(0,a.kt)("ol",p({},{start:7}),(0,a.kt)("li",{parentName:"ol"},"To uninstall the setup:\n",(0,a.kt)("inlineCode",{parentName:"li"},"helm uninstall <release-name> -n <namespace>"))),(0,a.kt)("h2",p({},{id:"kubernetes-cluster-setup"}),"Kubernetes Cluster Setup"),(0,a.kt)("h3",p({},{id:"dependencies-and-prerequisites"}),"Dependencies and Prerequisites"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Docker"),(0,a.kt)("li",{parentName:"ul"},"Kubernetes Cluster with Kubeadm"),(0,a.kt)("li",{parentName:"ul"},"Helm")),(0,a.kt)("p",null,"If you need to set up a Kubernetes cluster, you can refer to our installation script. If you plan on using your own cluster, you can skip to step 4. Follow these steps on your master/control-plane node :"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Setup the ha-cluster setups folder:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Copy or setup the ",(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling")," repository to the NFS server and Control-plane. For both instances the path of the repository has to be the same. Also make sure to create a directory inside the repository on Control-plane named ",(0,a.kt)("inlineCode",{parentName:"li"},"license")," that contains the ",(0,a.kt)("inlineCode",{parentName:"li"},"license.lic")," file we provided you."))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Choose Architecture Folder:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Depending on your host architecture, navigate to the corresponding folder:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"For Debian AMD64:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"cd mosquitto-2.7-mmc-2.7-cluster-kubernetes-autoscaling/kubernetes/multi-node-multi-host-autoscaling/debian_amd64\n"))))))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Install Common Dependencies:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Run the following command to install the necessary dependencies on all the nodes(including control-plane node):",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"bash common-installation-debian.sh\n"))))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Install Master Dependencies:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Run the following command to install the necessary dependencies on the master node:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"bash  master-installation-debian.sh\n"))))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Setup Kubernetes: IMPORTANT")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Execute the setup script to configure Kubernetes:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"bash setup.sh\n")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Follow the instructions of this file. This would create configmap for mosquitto.conf, create configmaps for your license file. Make sure you have placed your license file in the required folder before running this script i.e at ",(0,a.kt)("inlineCode",{parentName:"li"},"/home/<user>/mosquitto-2.7-mmc-2.7-cluster-kubernetes/license/license.lic")," (if license folder does not exist ,create it and add your license.lic file)"),(0,a.kt)("li",{parentName:"ul"},"The default namespace for installation is ",(0,a.kt)("inlineCode",{parentName:"li"},"multinode"),". You can change the namespace through the setup script. Script will prompt you to choose the namespace of your choice."))))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Setup Kubernetes Secrets:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"This step is required for kubernetes to pull required docker images from the registry. You can set the secrets using the following command:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",p({parentName:"pre"},{className:"language-bash"}),"kubectl create secret docker-registry  mosquitto-pro-secret  --docker-server=registry.cedalo.com --docker-username=<username> --docker-password=<password>  --docker-email=<email> -n <namespace>\n")))))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"namespace"),": ",(0,a.kt)("inlineCode",{parentName:"li"},"namespace")," should be the same as the one you selected or enetered while running the ",(0,a.kt)("inlineCode",{parentName:"li"},"setup.sh"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"docker-username"),": Your docker username"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"docker-password"),": Your docker password"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"docker-email"),": Email registered for accessing docker registry")),(0,a.kt)("h3",p({},{id:"further-useful-commands"}),"Further Useful Commands:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If you want to change mosquitto.conf. Make the required changes in mosquitto.conf then delete the configmap and create a new one. Make sure to uninstall the deployment before making the change."),(0,a.kt)("li",{parentName:"ul"},"You can uninstall the setup using the following command:\n",(0,a.kt)("inlineCode",{parentName:"li"},"helm uninstall <release-name> -n <namespace>")),(0,a.kt)("li",{parentName:"ul"},"To delete the configmap:\n",(0,a.kt)("inlineCode",{parentName:"li"},"kubectl delete configmap mosquitto-config -n <namespace>")),(0,a.kt)("li",{parentName:"ul"},"To reconfigure the configmap:\n",(0,a.kt)("inlineCode",{parentName:"li"},"kubectl create configmap mosquitto-config  -n $namespace --from-file=<path-to-mosquitto.conf>")),(0,a.kt)("li",{parentName:"ul"},"If you want to customize the deployments, you can unzip the package using:\n",(0,a.kt)("inlineCode",{parentName:"li"},"tar -xzvf mosquitto-multi-node-multi-host-autoscale-0.1.0.tgz")),(0,a.kt)("li",{parentName:"ul"},"Make the changes and repackage the folder mosquitto-multi-node-single-host using:\n",(0,a.kt)("inlineCode",{parentName:"li"},"helm package mosquitto-multi-node-multi-host-autoscale "))),(0,a.kt)("h2",p({},{id:"usage"}),"Usage"),(0,a.kt)("p",null,"Once the installation is complete, you can start using the multi-node Mosquitto broker. Be sure to check the Mosquitto documentation for further details on configuring and using the broker."))}f.isMDXComponent=!0}}]);