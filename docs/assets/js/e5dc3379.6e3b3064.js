"use strict";(self.webpackChunkstreamsheets=self.webpackChunkstreamsheets||[]).push([[47003],{3905:(e,t,i)=>{i.d(t,{Zo:()=>u,kt:()=>d});var n=i(67294);function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(Object(i),!0).forEach((function(t){o(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t){if(null==e)return{};var i,n,o=function(e,t){if(null==e)return{};var i,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)i=r[n],t.indexOf(i)>=0||(o[i]=e[i]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)i=r[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(o[i]=e[i])}return o}var l=n.createContext({}),p=function(e){var t=n.useContext(l),i=t;return e&&(i="function"==typeof e?e(t):a(a({},t),e)),i},u=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var i=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(i),d=o,h=m["".concat(l,".").concat(d)]||m[d]||c[d]||r;return i?n.createElement(h,a(a({ref:t},u),{},{components:i})):n.createElement(h,a({ref:t},u))}));function d(e,t){var i=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=i.length,a=new Array(r);a[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,a[1]=s;for(var p=2;p<r;p++)a[p]=i[p];return n.createElement.apply(null,a)}return n.createElement.apply(null,i)}m.displayName="MDXCreateElement"},41979:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>y,contentTitle:()=>d,default:()=>k,frontMatter:()=>m,metadata:()=>h,toc:()=>f});var n=i(3905),o=Object.defineProperty,r=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,u=(e,t,i)=>t in e?o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,c=(e,t)=>{for(var i in t||(t={}))l.call(t,i)&&u(e,i,t[i]);if(s)for(var i of s(t))p.call(t,i)&&u(e,i,t[i]);return e};const m={id:"os-to-pro-migration",title:"How to migrate from OS Mosquitto to Pro Mosquitto",sidebar_label:"OS to Pro Mosquitto"},d=void 0,h={unversionedId:"deployment/on-premises/os-to-pro-migration",id:"version-3.1/deployment/on-premises/os-to-pro-migration",title:"How to migrate from OS Mosquitto to Pro Mosquitto",description:"In this guide you will learn how to modify your current OS Mosquitto configuration files such that you can use them to setup a Pro Mosquitto broker without losing data. To shorten things we will use the terms OS Broker and Eclipse Mosquitto Broker synonym.",source:"@site/mosquitto_versioned_docs/version-3.1/deployment/on-premises/os-to-pro-migration.md",sourceDirName:"deployment/on-premises",slug:"/deployment/on-premises/os-to-pro-migration",permalink:"/mosquitto/deployment/on-premises/os-to-pro-migration",draft:!1,tags:[],version:"3.1",frontMatter:{id:"os-to-pro-migration",title:"How to migrate from OS Mosquitto to Pro Mosquitto",sidebar_label:"OS to Pro Mosquitto"}},y={},f=[{value:"General recommendations",id:"general-recommendations",level:2},{value:"Dynamic Security plugin",id:"dynamic-security-plugin",level:2},{value:"Requirements",id:"requirements",level:3},{value:"Migration script",id:"migration-script",level:3},{value:"Merge setups",id:"merge-setups",level:3},{value:"Scenario 1: No authentication and authorization mechanism is in place",id:"scenario-1-no-authentication-and-authorization-mechanism-is-in-place",level:4},{value:"Scenario 2: ACL file and password file",id:"scenario-2-acl-file-and-password-file",level:4},{value:"Scenario 3: Dynamic Security plugin",id:"scenario-3-dynamic-security-plugin",level:4},{value:"Persist SQLite plugin",id:"persist-sqlite-plugin",level:2},{value:"Requirements",id:"requirements-1",level:3},{value:"Migration script",id:"migration-script-1",level:3},{value:"Merge setups",id:"merge-setups-1",level:3},{value:"Scenario 1: No persistence",id:"scenario-1-no-persistence",level:4},{value:"Scenario 2: Snapshot persistence",id:"scenario-2-snapshot-persistence",level:4},{value:"Scenario 3: Persist SQLite",id:"scenario-3-persist-sqlite",level:4}],g={toc:f};function k(e){var t,i=e,{components:o}=i,u=((e,t)=>{var i={};for(var n in e)l.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&s)for(var n of s(e))t.indexOf(n)<0&&p.call(e,n)&&(i[n]=e[n]);return i})(i,["components"]);return(0,n.kt)("wrapper",(t=c(c({},g),u),r(t,a({components:o,mdxType:"MDXLayout"}))),(0,n.kt)("p",null,"In this guide you will learn how to modify your current OS Mosquitto configuration files such that you can use them to setup a Pro Mosquitto broker without losing data. To shorten things we will use the terms ",(0,n.kt)("inlineCode",{parentName:"p"},"OS Broker")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"Eclipse Mosquitto Broker")," synonym."),(0,n.kt)("h2",c({},{id:"general-recommendations"}),"General recommendations"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Before proceeding with the following chapters please make sure to setup the Pro Mosquitto broker alongside the OS Mosquitto broker. The main reason is that, in case anything breaks during the migration you still have your old setup up and running. This means that you should simply copy things from your current OS Mosquitto setup into the newly downloaded Pro Mosquitto setup.")),(0,n.kt)("h2",c({},{id:"dynamic-security-plugin"}),"Dynamic Security plugin"),(0,n.kt)("p",null,"Having proper authentication and authorization enabled on a data service is mandatory in today's IIoT world. The ",(0,n.kt)("a",c({parentName:"p"},{href:"/mosquitto/security/mosquitto/dynamic-security"}),"Dynamic Security plugin")," of the Pro Mosquitto broker implements mechanisms for both auth tasks by providing Role Based Access Control (RBAC). Moreover, configuring it during runtime is also possible via its MQTT Control API. Last but not least, it is ready to be run in clustered environments without any further need for extra configuration."),(0,n.kt)("h3",c({},{id:"requirements"}),"Requirements"),(0,n.kt)("p",null,"The ",(0,n.kt)("a",c({parentName:"p"},{href:"/mosquitto/security/mosquitto/dynamic-security"}),"Dynamic Security plugin")," must be enabled for the Cedalo MQTT Platform, which offers a straightforward way of configuring user authentication and authorization via a neat web UI."),(0,n.kt)("h3",c({},{id:"migration-script"}),"Migration script"),(0,n.kt)("p",null,"In case you have configured authentication and authorization via the ",(0,n.kt)("inlineCode",{parentName:"p"},"acl_file")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"password_file")," options in the ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf")," we highly recommend switching to Dynamic Security plugin as described previously. Setting up a ",(0,n.kt)("inlineCode",{parentName:"p"},"dynamic-security.json")," properly from scratch can be as time-consuming as it is error-prone. Therefore, we created a migration script that helps you migrating your ACL file and password file into a single ",(0,n.kt)("inlineCode",{parentName:"p"},"dynamic-security.json")," file. Optionally you can also directly edit the ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf")," options using the script. It can be found in the ",(0,n.kt)("a",c({parentName:"p"},{href:"https://github.com/eclipse-mosquitto/mosquitto/blob/develop/plugins/dynamic-security/migrate_to_dynsec.py"}),"OS Mosquitto repository"),". Having a recent python version installed on your machine is the only requirement to execute the script."),(0,n.kt)("admonition",c({},{type:"info"}),(0,n.kt)("p",{parentName:"admonition"},"Please make sure to run the script in your current setup. Also you do not have to worry about backing up your current configuration files as the script will not delete anything on your disk. In case of ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf")," migration the old file will simply be renamed after migration, resulting in the migrated version being named ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf")," and your previous one named ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf.old.dynsec"),".")),(0,n.kt)("p",null,"The following is a complete list of the usage options:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Print usage help:"))),(0,n.kt)("pre",null,(0,n.kt)("code",c({parentName:"pre"},{className:"language-bash"}),"python3 migrate_to_dynsec.py -h\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Migrate (without mosquitto.conf):"))),(0,n.kt)("pre",null,(0,n.kt)("code",c({parentName:"pre"},{className:"language-bash"}),"python3 migrate_to_dynsec.py --acl-file path/to/acl_file --pw-file path/to/pw_file\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Migrate (including mosquitto.conf):"))),(0,n.kt)("pre",null,(0,n.kt)("code",c({parentName:"pre"},{className:"language-bash"}),"python3 migrate_to_dynsec.py --acl-file path/to/acl_file --pw-file path/to/pw_file --conf path/to/mosquitto.conf --dynsec-lib path/to/mosquitto_dynamic_security.so/.dll\n")),(0,n.kt)("admonition",c({},{type:"note"}),(0,n.kt)("p",{parentName:"admonition"},"For each of our Pro Mosquitto deployment options, except for Windows and RPM packages, the Dynamic Security library (and other libraries) will be placed in the ",(0,n.kt)("inlineCode",{parentName:"p"},"/usr/lib")," directory. For the Dynamic Security plugin this means the path you have to set for the ",(0,n.kt)("inlineCode",{parentName:"p"},"--dynsec-lib")," command line argument is: ",(0,n.kt)("inlineCode",{parentName:"p"},"/usr/lib/mosquitto_dynamic_security.so"),".")),(0,n.kt)("h3",c({},{id:"merge-setups"}),"Merge setups"),(0,n.kt)("p",null,"As a final step you need to merge the ",(0,n.kt)("inlineCode",{parentName:"p"},"dynamic-security.json")," files of your setup and the new Pro Mosquitto setup. Please perform the following steps depending on your current configuration:"),(0,n.kt)("h4",c({},{id:"scenario-1-no-authentication-and-authorization-mechanism-is-in-place"}),"Scenario 1: No authentication and authorization mechanism is in place"),(0,n.kt)("p",null,"As everything is setup by default, you can move on to the ",(0,n.kt)("a",c({parentName:"p"},{href:"#persist-sqlite-plugin"}),"next section"),"."),(0,n.kt)("admonition",c({},{type:"caution"}),(0,n.kt)("p",{parentName:"admonition"},"Setting the ",(0,n.kt)("inlineCode",{parentName:"p"},"allow_anonymous")," option to ",(0,n.kt)("inlineCode",{parentName:"p"},"true")," should be wisely considered. Without applying any authentication methods this can lead to uncontrolled data access by unauthenticated and/or unauthorized entities. It is strongly recommended to at least enable the Dynamic Security plugin for basic username/password authentication.")),(0,n.kt)("h4",c({},{id:"scenario-2-acl-file-and-password-file"}),"Scenario 2: ACL file and password file"),(0,n.kt)("p",null,"If not already done, please run the ",(0,n.kt)("a",c({parentName:"p"},{href:"#migration-script"}),"migration script")," to retrieve a ",(0,n.kt)("inlineCode",{parentName:"p"},"dynamic-security.json")," file that reflects your current settings of your ACL file and password file. Afterwards simply run the steps from ",(0,n.kt)("a",c({parentName:"p"},{href:"#scenario-3-dynamic-security-plugin"}),"Scenario 3"),"."),(0,n.kt)("h4",c({},{id:"scenario-3-dynamic-security-plugin"}),"Scenario 3: Dynamic Security plugin"),(0,n.kt)("p",null,"For this scenario the only requirement for you is to copy the contents of the fields of your (migrated) ",(0,n.kt)("inlineCode",{parentName:"p"},"dynamic-security.json")," into the one in the Pro Mosquitto broker setup. Also make sure that you do not override the ",(0,n.kt)("inlineCode",{parentName:"p"},"admin")," client (see note below) and assert that there are no duplicates between your and the default ",(0,n.kt)("inlineCode",{parentName:"p"},"dynamic-security.json")," that comes along with the Pro Mosquitto broker setup."),(0,n.kt)("admonition",c({},{type:"note"}),(0,n.kt)("p",{parentName:"admonition"},"The ",(0,n.kt)("inlineCode",{parentName:"p"},"admin")," client is used by the Cedalo MQTT Platform to perform MQTT Control requests to, e.g., create a Dynamic Security client, or to subscribe to ",(0,n.kt)("inlineCode",{parentName:"p"},"$SYS/#")," topics to display statistics on its dashboard. Such operations require certain authorizations to publish to or subscribe on various topics. In the following possible scenarios are evaluated, which each require different handling in terms of the ",(0,n.kt)("inlineCode",{parentName:"p"},"admin")," client."),(0,n.kt)("p",{parentName:"admonition"},"A default version of the Dynamic Security plugin's configuration is contained in the pre-configured Pro Mosquitto setup. It includes the ",(0,n.kt)("inlineCode",{parentName:"p"},"admin")," client as well, whose credentials are stored in the ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto_client_info.txt"),".")),(0,n.kt)("h2",c({},{id:"persist-sqlite-plugin"}),"Persist SQLite plugin"),(0,n.kt)("p",null,"Enabling persistence on a Mosquitto broker improves reliability by providing features like persistent sessions, which lets clients receive messages sent while they were offline, once they reconnect. Currently, the OS Broker Snapshot persistence and the ",(0,n.kt)("inlineCode",{parentName:"p"},"Persist SQLite plugin")," exist. We strongly recommend to use the ",(0,n.kt)("inlineCode",{parentName:"p"},"Persist SQLite plugin")," over Snapshot persistence. This is mainly due to the fact that the Snapshot persistence writes bulks per dump. At first this might sound sensible, but comes at the cost of possible several seconds of service interruption for largely scaled setups or brokers which are on higher load, which is likely not acceptable. The ",(0,n.kt)("inlineCode",{parentName:"p"},"Persist SQLite plugin")," solves this issue by providing a solution that writes data continuosly, mitigating time consumption issues due to disk write operations. Moreover, in scenarios where data loss and downtimes of clients cannot be prevented (e.g., moving assets like a car fleet) ",(0,n.kt)("a",c({parentName:"p"},{href:"/mosquitto/advanced-features/persistent-queueing"}),"Persistent Queueing")," increases the mechanism of message queueing in the broker. This feature can only be used with the ",(0,n.kt)("inlineCode",{parentName:"p"},"Persist SQLite plugin"),"."),(0,n.kt)("h3",c({},{id:"requirements-1"}),"Requirements"),(0,n.kt)("p",null,"For other premium features like ",(0,n.kt)("a",c({parentName:"p"},{href:"/mosquitto/advanced-features/persistent-queueing"}),"Persistent Queueing")," it is important to have a performant and reliable persistence plugin activated. The ",(0,n.kt)("inlineCode",{parentName:"p"},"Persist SQLite plugin")," fulfills those needs and should therefore be enabled on the Pro Mosquitto broker setup instead of Snapshot persistence."),(0,n.kt)("h3",c({},{id:"migration-script-1"}),"Migration script"),(0,n.kt)("p",null,"In case you set the ",(0,n.kt)("inlineCode",{parentName:"p"},"persistence")," option to ",(0,n.kt)("inlineCode",{parentName:"p"},"true")," in your current setup we suggest to migrate to the ",(0,n.kt)("inlineCode",{parentName:"p"},"Persist SQLite plugin"),". The migration script dumps out your current ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.db")," (or whatever you specified as ",(0,n.kt)("inlineCode",{parentName:"p"},"persist_file"),") into a JSON string and creates the ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.sqlite3")," database file using it, as if it has been using the ",(0,n.kt)("inlineCode",{parentName:"p"},"Persist SQLite plugin")," all the time. Furthermore, it allows for automated migration of the ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf")," file as well. In case you built the OS Mosquitto project yourself or the ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto_dump_tool")," is not part of your path for another reason you can also specify the path to that executable."),(0,n.kt)("admonition",c({},{type:"info"}),(0,n.kt)("p",{parentName:"admonition"},"Please make sure to run the script in your current setup. Also you do not have to worry about backing up your current configuration files as the script will not delete anything on your disk. In case of ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf")," migration the old file will simply be renamed after migration, resulting in the migrated version being named ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf")," and your previous one named ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf.old.persistence"),".")),(0,n.kt)("p",null,"The following is a list of the usage options:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Print usage help:"))),(0,n.kt)("pre",null,(0,n.kt)("code",c({parentName:"pre"},{className:"language-bash"}),"python3 migrate_to_persist_sqlite.py -h\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Migrate (without mosquitto.conf):"))),(0,n.kt)("pre",null,(0,n.kt)("code",c({parentName:"pre"},{className:"language-bash"}),"python3 migrate_to_persist_sqlite.py --persistence-db path/to/persistence_db\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Migrate (including mosquitto.conf):"))),(0,n.kt)("pre",null,(0,n.kt)("code",c({parentName:"pre"},{className:"language-bash"}),"python3 migrate_to_persist_sqlite.py --persistence-db path/to/persistence_db --conf path/to/mosquitto.conf --persist-sqlite-lib path/to/mosquitto_persist_sqlite.so/.dll\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Migrate (",(0,n.kt)("inlineCode",{parentName:"strong"},"mosquitto_dump_tool")," not in PATH):"))),(0,n.kt)("pre",null,(0,n.kt)("code",c({parentName:"pre"},{className:"language-bash"}),"python3 migrate_to_persist_sqlite.py --persistence-db path/to/persistence_db --dump-tool path/to/mosquitto_dump_tool\n")),(0,n.kt)("h3",c({},{id:"merge-setups-1"}),"Merge setups"),(0,n.kt)("p",null,"As a final step you need to make sure that the Pro Mosquitto setup is using the correct SQLite3 database. Please perform the following steps depending on your current configuration:"),(0,n.kt)("h4",c({},{id:"scenario-1-no-persistence"}),"Scenario 1: No persistence"),(0,n.kt)("p",null,"The ",(0,n.kt)("inlineCode",{parentName:"p"},"Persist SQLite plugin")," is activated by default in our Pro Mosquitto setups, hence, you can move on to the ",(0,n.kt)("a",c({parentName:"p"},{href:"#TODO"}),"next section"),"."),(0,n.kt)("h4",c({},{id:"scenario-2-snapshot-persistence"}),"Scenario 2: Snapshot persistence"),(0,n.kt)("p",null,"If not already done, please run the ",(0,n.kt)("a",c({parentName:"p"},{href:"#migration-script-1"}),"migration script")," to retrieve the ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.sqlite3")," database file. Afterwards simply run the steps from ",(0,n.kt)("a",c({parentName:"p"},{href:"#scenario-3-persist-sqlite"}),"Scenario 3"),"."),(0,n.kt)("h4",c({},{id:"scenario-3-persist-sqlite"}),"Scenario 3: Persist SQLite"),(0,n.kt)("p",null,"In this case you simply have to copy the ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.sqlite3")," database file into the ",(0,n.kt)("inlineCode",{parentName:"p"},"persistence_location")," path that is defined in the ",(0,n.kt)("inlineCode",{parentName:"p"},"mosquitto.conf")," of your new Pro Mosquitto setup. If you assigned a custom name to the database, please copy the ",(0,n.kt)("inlineCode",{parentName:"p"},"plugin_opt_db_file")," option as well."))}k.isMDXComponent=!0}}]);