"use strict";(self.webpackChunkstreamsheets=self.webpackChunkstreamsheets||[]).push([[33275],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=u(n),d=r,k=c["".concat(s,".").concat(d)]||c[d]||m[d]||o;return n?a.createElement(k,i(i({ref:t},p),{},{components:n})):a.createElement(k,i({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},11922:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>g,contentTitle:()=>d,default:()=>f,frontMatter:()=>c,metadata:()=>k,toc:()=>N});var a=n(3905),r=Object.defineProperty,o=Object.defineProperties,i=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,p=(e,t,n)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,m=(e,t)=>{for(var n in t||(t={}))s.call(t,n)&&p(e,n,t[n]);if(l)for(var n of l(t))u.call(t,n)&&p(e,n,t[n]);return e};const c={id:"high-availability",title:"Kubernetes High Availability",sidebar_label:"High Availability"},d=void 0,k={unversionedId:"deployment/on-premises/deployment/installation/kubernetes/high-availability",id:"version-3.1/deployment/on-premises/deployment/installation/kubernetes/high-availability",title:"Kubernetes High Availability",description:"This setup will deploy HA Mosquitto broker and Platform on a managed kubernetes cluster like GKE (Google), EKS (Amazon) or Azure Kubernetes using Helm charts.",source:"@site/mosquitto_versioned_docs/version-3.1/deployment/on-premises/deployment/installation/kubernetes/high-availability.md",sourceDirName:"deployment/on-premises/deployment/installation/kubernetes",slug:"/deployment/on-premises/deployment/installation/kubernetes/high-availability",permalink:"/mosquitto/deployment/on-premises/deployment/installation/kubernetes/high-availability",draft:!1,tags:[],version:"3.1",frontMatter:{id:"high-availability",title:"Kubernetes High Availability",sidebar_label:"High Availability"},sidebar:"someSidebar",previous:{title:"Single Node",permalink:"/mosquitto/deployment/on-premises/deployment/installation/kubernetes/single-node"},next:{title:"Introduction",permalink:"/mosquitto/deployment/on-premises/deployment/installation/openshift/introduction-openshift"}},g={},N=[{value:"HAProxy Configuration",id:"haproxy-configuration",level:2},{value:"DNS-Based Service Discovery",id:"dns-based-service-discovery",level:3},{value:"Dynamic Backend Configuration",id:"dynamic-backend-configuration",level:3},{value:"Replica Count Requirements",id:"replica-count-requirements",level:3},{value:"Kubernetes Cluster Setup",id:"kubernetes-cluster-setup",level:2},{value:"Dependencies and Prerequisites",id:"dependencies-and-prerequisites",level:3},{value:"Installation",id:"installation",level:2},{value:"Installation using Helm Charts:",id:"installation-using-helm-charts",level:3},{value:"Further possible Configurations",id:"further-possible-configurations",level:4},{value:"Advanced Configuration",id:"advanced-configuration",level:2},{value:"Configurable Mosquitto Broker Settings",id:"configurable-mosquitto-broker-settings",level:3},{value:"<strong>Mosquitto Configuration Options</strong>",id:"mosquitto-configuration-options",level:4},{value:"<strong>HAProxy Configuration</strong>",id:"haproxy-configuration-1",level:4},{value:"<strong>Plugin Configuration</strong>",id:"plugin-configuration",level:4},{value:"<strong>Complete Example with Custom Configuration</strong>",id:"complete-example-with-custom-configuration",level:4},{value:"<strong>Updating Configuration After Installation</strong>",id:"updating-configuration-after-installation",level:4},{value:"Prometheus Monitoring Integration",id:"prometheus-monitoring-integration",level:3},{value:"<strong>Prerequisites</strong>",id:"prerequisites",level:4},{value:"<strong>Configuration for HA Cluster</strong>",id:"configuration-for-ha-cluster",level:4},{value:"<strong>Verifying Prometheus Integration</strong>",id:"verifying-prometheus-integration",level:4},{value:"<strong>Troubleshooting</strong>",id:"troubleshooting",level:4},{value:"NetworkPolicy Security (Optional)",id:"networkpolicy-security-optional",level:2},{value:"Prerequisites",id:"prerequisites-1",level:3},{value:"Enable NetworkPolicies",id:"enable-networkpolicies",level:3},{value:"DNS Configuration (Configurable)",id:"dns-configuration-configurable",level:3},{value:"Default Configuration (Standard Kubernetes)",id:"default-configuration-standard-kubernetes",level:4},{value:"Custom DNS Configuration",id:"custom-dns-configuration",level:4},{value:"Detect DNS Configuration",id:"detect-dns-configuration",level:4},{value:"What NetworkPolicies Control",id:"what-networkpolicies-control",level:3},{value:"Create-Cluster Job Support",id:"create-cluster-job-support",level:3},{value:"Verification",id:"verification",level:3},{value:"Important Notes",id:"important-notes",level:3},{value:"Connect to cluster",id:"connect-to-cluster",level:2},{value:"Usage",id:"usage",level:2}],h={toc:N};function f(e){var t,n=e,{components:r}=n,p=((e,t)=>{var n={};for(var a in e)s.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&l)for(var a of l(e))t.indexOf(a)<0&&u.call(e,a)&&(n[a]=e[a]);return n})(n,["components"]);return(0,a.kt)("wrapper",(t=m(m({},h),p),o(t,i({components:r,mdxType:"MDXLayout"}))),(0,a.kt)("p",null,"This setup will deploy HA Mosquitto broker and Platform on a managed kubernetes cluster like GKE (Google), EKS (Amazon) or Azure Kubernetes using Helm charts.\nThis setup would deploy a 3 Mosquitto broker as a statefulsets. Also, a Platform pod and HA-proxy pods replicas as a deployment entity. This deployment by default uses a Persistent volumes for persistence. We use HA Proxy as an endpoint in front of the mosquitto pods. The user connects to HAproxy endpoint and"),(0,a.kt)("h2",m({},{id:"haproxy-configuration"}),"HAProxy Configuration"),(0,a.kt)("p",null,"HAProxy acts as a load balancer in front of the Mosquitto cluster, providing a single entry point for MQTT clients while distributing connections across all broker replicas."),(0,a.kt)("h3",m({},{id:"dns-based-service-discovery"}),"DNS-Based Service Discovery"),(0,a.kt)("p",null,"HAProxy uses Kubernetes DNS to discover and connect to Mosquitto broker pods. Each StatefulSet pod has a predictable DNS name:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"DNS Pattern:")," ",(0,a.kt)("inlineCode",{parentName:"p"},"<pod-name>.<service-name>.<namespace>.svc.cluster.local")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Examples:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-0.mosquitto.ha.svc.cluster.local")," (first broker)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-1.mosquitto.ha.svc.cluster.local")," (second broker)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-2.mosquitto.ha.svc.cluster.local")," (third broker)")),(0,a.kt)("h3",m({},{id:"dynamic-backend-configuration"}),"Dynamic Backend Configuration"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"IMPORTANT"),": The Helm chart automatically generates HAProxy backend server entries based on your ",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto.replicas")," setting. You don't need to manually configure individual servers."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Key Configuration Parameters:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"nameserver"),": DNS server IP for resolving Mosquitto pod addresses (required during installation)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto.replicas"),": Number of broker replicas (default: 3) - HAProxy automatically configures backends for all replicas"),(0,a.kt)("li",{parentName:"ul"},"Health checks (",(0,a.kt)("inlineCode",{parentName:"li"},"check inter 5s fall 3 rise 2"),") ensure only healthy brokers receive traffic")),(0,a.kt)("h3",m({},{id:"replica-count-requirements"}),"Replica Count Requirements"),(0,a.kt)("p",null,"\u26a0\ufe0f ",(0,a.kt)("strong",{parentName:"p"},"IMPORTANT: Always use an ODD number of Mosquitto broker replicas")," (3, 5, 7, 9, etc.)"),(0,a.kt)("p",null,"The Raft consensus algorithm used for cluster coordination requires an odd number of nodes to establish quorum and elect a leader:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Quorum and Fault Tolerance:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"3 nodes"),": Tolerates 1 failure (requires 2 nodes for quorum)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"5 nodes"),": Tolerates 2 failures (requires 3 nodes for quorum)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"7 nodes"),": Tolerates 3 failures (requires 4 nodes for quorum)")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Why Odd Numbers?")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Raft requires a majority (quorum) for leader election and consensus"),(0,a.kt)("li",{parentName:"ul"},"Even numbers can cause split-brain scenarios where no majority exists"),(0,a.kt)("li",{parentName:"ul"},"Odd numbers ensure a clear majority is always possible")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Examples:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u2705 ",(0,a.kt)("strong",{parentName:"li"},"Recommended"),": 3, 5, 7, 9 replicas"),(0,a.kt)("li",{parentName:"ul"},"\u274c ",(0,a.kt)("strong",{parentName:"li"},"Not Recommended"),": 2, 4, 6, 8 replicas (can cause cluster instability)")),(0,a.kt)("h2",m({},{id:"kubernetes-cluster-setup"}),"Kubernetes Cluster Setup"),(0,a.kt)("h3",m({},{id:"dependencies-and-prerequisites"}),"Dependencies and Prerequisites"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Running managed kubernetes setup (GKE, EKS, AKS etc). Follow documentation guide for the respective kubernetes cluster to create a cluster on your chosen cloud provider."),(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Create a namespace")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Once you are connected to your Kubernetes setup and can access the cluster using ",(0,a.kt)("inlineCode",{parentName:"li"},"kubectl")," tool. Create a namespace in which you would want to deploy the application. The deployment folder is pre-configured for the namespace named ",(0,a.kt)("inlineCode",{parentName:"li"},"ha"),". If you want to use the default configuration you can create a namespace named ",(0,a.kt)("inlineCode",{parentName:"li"},"ha")," using the below command:"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"kubectl create namespace ha")),(0,a.kt)("li",{parentName:"ul"},"If you want to use a different namespace, use the command: ",(0,a.kt)("inlineCode",{parentName:"li"},"kubectl create namespace <your-custom-namespace>"),".  Replace ",(0,a.kt)("inlineCode",{parentName:"li"},"<your-custom-namespace>")," with the name of the namespace you want to configure.")))),(0,a.kt)("h2",m({},{id:"installation"}),"Installation"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Prerequisites"),":\nKubernetes Cluster should be up and running. If you are yet to setup the cluster, refer ",(0,a.kt)("a",m({parentName:"p"},{href:"#kubernetes-cluster-setup"}),"Kubernetes Cluster Setup"),".\nOnce kubernetes cluster is up and running then you can now follow these steps to install the HA Mosquitto broker setup:"),(0,a.kt)("h3",m({},{id:"installation-using-helm-charts"}),"Installation using Helm Charts:"),(0,a.kt)("p",null,"Helm charts offer a comprehensive solution for configuring various Kubernetes resources\u2014including stateful sets, deployment templates, services, and service accounts\u2014through a single command, streamlining the deployment process. When the user downloads helm package from the Platform license key is already part of the package."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Get the helm chart")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Make sure you have the helm chart  ",(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-3.1-platform-3.1-kubernetes-cluster.tgz")," downloaded from the Platform portal."))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Install Helm Chart:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Use the following ",(0,a.kt)("inlineCode",{parentName:"p"},"helm install")," command to deploy the Mosquitto application on to your Kubernetes cluster. Replace ",(0,a.kt)("inlineCode",{parentName:"p"},"<release-name>")," with the desired name for your Helm release and ",(0,a.kt)("inlineCode",{parentName:"p"},"<namespace>")," with your chosen Kubernetes namespace:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm install <release-name> mosquitto-3.1-platform-3.1-kubernetes-cluster.tgz -n <namespace> --set nameserver=<nameserver-ip>\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Required Parameters:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set licenseKey=<your-license-key>"),": Your Cedalo Mosquitto license key (required)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set nameserver=<dns-server-ip>"),": DNS server IP address for HAProxy DNS resolution (required for HA). Find using ",(0,a.kt)("inlineCode",{parentName:"li"},"kubectl get svc -n kube-system")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Common Configuration Options:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set storageClass=<storage-class-name>"),": Storage class for persistent volumes. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"standard-rwo")," (GCP). Common values:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"GCP: ",(0,a.kt)("inlineCode",{parentName:"li"},"standard-rwo"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"premium-rwo")),(0,a.kt)("li",{parentName:"ul"},"AWS: ",(0,a.kt)("inlineCode",{parentName:"li"},"gp2"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"gp3"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"io1")),(0,a.kt)("li",{parentName:"ul"},"Azure: ",(0,a.kt)("inlineCode",{parentName:"li"},"managed"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"managed-premium")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.serviceType=<serviceType>"),": Service type for HAProxy LoadBalancer. Options: ",(0,a.kt)("inlineCode",{parentName:"li"},"LoadBalancer")," (default), ",(0,a.kt)("inlineCode",{parentName:"li"},"NodePort"),", or ",(0,a.kt)("inlineCode",{parentName:"li"},"ClusterIP")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set platform.serviceType=<serviceType>"),": Service type for Platform UI. Options: ",(0,a.kt)("inlineCode",{parentName:"li"},"LoadBalancer")," (default), ",(0,a.kt)("inlineCode",{parentName:"li"},"NodePort"),", or ",(0,a.kt)("inlineCode",{parentName:"li"},"ClusterIP")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.pullPolicy=<pullPolicy>"),": Image pull policy. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"Always"),". Options: ",(0,a.kt)("inlineCode",{parentName:"li"},"Always"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"IfNotPresent"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"Never")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set imagePullSecrets[0].name=<secret-name>"),": Image pull secret for private registries. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-pro-secret")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"High Availability Configuration:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.replicas=<replica-count>"),": Number of Mosquitto broker replicas. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"3"),". Max limited by your license"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.replicas=<replica-count>"),": Number of HAProxy replicas. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"3")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.listener=<port>"),": HAProxy MQTT listener port. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.secureListener=<port>"),": HAProxy secure MQTT listener port (if TLS enabled). Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8883")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Storage Configuration:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.persistentStorageCapacity=<size>"),": Storage size per Mosquitto broker. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1Gi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set platform.persistentStorageCapacity=<size>"),": Storage size for Platform data. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1Gi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set platform.persistentLogStorageCapacity=<size>"),": Storage size for Platform logs. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1Gi")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Resource Configuration:")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.resources.requests.cpu=<cpu>"),": Mosquitto CPU request per replica. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"200m")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.resources.requests.memory=<memory>"),": Mosquitto memory request per replica. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"512Mi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.requests.cpu=<cpu>"),": HAProxy CPU request. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"100m")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.requests.memory=<memory>"),": HAProxy memory request. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"256Mi")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Sample Installation Command:")),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm install my-ha-cluster mosquitto-3.1-platform-3.1-kubernetes-cluster.tgz -n ha \\\n  --set licenseKey=<your-license-key> \\\n  --set nameserver=10.0.0.10 \\\n  --set storageClass=standard-rwo \\\n  --set mosquitto.replicas=3 \\\n  --set haproxy.serviceType=LoadBalancer \\\n  --set platform.serviceType=LoadBalancer\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Note:")," You can explore further configuration options in ",(0,a.kt)("inlineCode",{parentName:"p"},"values.yaml"))))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"You can monitor the running pods using the ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl get pods -o wide -n <namespace>")," command. To observe the service endpoints ports use ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl get svc -n <namespace>"),".")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The default type of cluster would a HA cluster.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"To uninstall the setup:\n",(0,a.kt)("inlineCode",{parentName:"p"},"helm uninstall <release-name> -n <namespace>")))),(0,a.kt)("p",null,"Your Mosquitto setup is now running  with three single mosquitto nodes in a HA cluster along with a Platform portal."),(0,a.kt)("h4",m({},{id:"further-possible-configurations"}),"Further possible Configurations"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Add Nodes:")," If you want to add more nodes to the existing cluster of three nodes. Make sure your license allows more than three nodes before proceeding."),(0,a.kt)("p",{parentName:"li"}," ",(0,a.kt)("strong",{parentName:"p"},"IMPORTANT"),": The Helm chart now ",(0,a.kt)("strong",{parentName:"p"},"automatically generates HAProxy server entries")," based on the ",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto.replicas")," value. You no longer need to manually edit the HAProxy configuration!"),(0,a.kt)("p",{parentName:"li"}," ",(0,a.kt)("strong",{parentName:"p"},"To add nodes, simply:")),(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Update the deployment with the new replica count:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm upgrade <release-name> mosquitto-3.1-platform-3.1-kubernetes-cluster.tgz -n <namespace> \\\n  --reuse-values \\\n  --set mosquitto.replicas=5\n")),(0,a.kt)("p",{parentName:"li"},"This will:"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Automatically update HAProxy ConfigMap with all 5 server entries"),(0,a.kt)("li",{parentName:"ul"},"Scale the Mosquitto StatefulSet to 5 replicas"),(0,a.kt)("li",{parentName:"ul"},"Restart HAProxy pods with the new configuration"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Verify the new pods are running:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"kubectl get pods -n <namespace> | grep mosquitto\n")),(0,a.kt)("p",{parentName:"li"},"You should see mosquitto-0 through mosquitto-4 (for 5 replicas)")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Verify HAProxy configuration:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"kubectl get configmap haproxyconfig -n <namespace> -o yaml\n")),(0,a.kt)("p",{parentName:"li"},"You should see server entries m1 through m5"))),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Adding new node to existing cluster:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Navigate to ",(0,a.kt)("inlineCode",{parentName:"li"},"Connections")," section on Platform portal and click ",(0,a.kt)("inlineCode",{parentName:"li"},"Edit"),"."),(0,a.kt)("li",{parentName:"ul"},"Click  ",(0,a.kt)("inlineCode",{parentName:"li"},"Add Node"),"."),(0,a.kt)("li",{parentName:"ul"},"Fill in the details like ",(0,a.kt)("inlineCode",{parentName:"li"},"Name")," and  ",(0,a.kt)("inlineCode",{parentName:"li"},"Private Address")," (make sure that the ",(0,a.kt)("inlineCode",{parentName:"li"},"Private Address"),"  does not conflict with the existing ones), ",(0,a.kt)("inlineCode",{parentName:"li"},"NAME"),": name of the connection (you can choose your own name)."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"URL"),": ",(0,a.kt)("inlineCode",{parentName:"li"},"mqtt://mosquitto-x.mosquitto.<namespace>.svc.cluster.local:1885"),"  . Replace ",(0,a.kt)("inlineCode",{parentName:"li"},"x")," in ",(0,a.kt)("inlineCode",{parentName:"li"},"mosquitto-x")," with a valid number based on the which node you are adding. If you are adding a fourth node and the name of your namespace is  ",(0,a.kt)("inlineCode",{parentName:"li"},"ha")," then the entry would be ",(0,a.kt)("inlineCode",{parentName:"li"},"mqtt://mosquitto-3.mosquitto.multinode.svc.cluster.local:1885"),". If you are adding a fifth node and the name of your namespace is  ",(0,a.kt)("inlineCode",{parentName:"li"},"ha")," then the entry would be ",(0,a.kt)("inlineCode",{parentName:"li"},"mqtt://mosquitto-4.mosquitto.ha.svc.cluster.local:1885"),"."),(0,a.kt)("li",{parentName:"ul"},"Add your username and password given by the cedalo team, select/deselect further options."),(0,a.kt)("li",{parentName:"ul"},"Select ",(0,a.kt)("inlineCode",{parentName:"li"},"Test Connection")," to verify your connection. If the connection succeeds proceed to next step or else verify your configuration.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Select ",(0,a.kt)("inlineCode",{parentName:"li"},"Add Node")," and  click ",(0,a.kt)("inlineCode",{parentName:"li"},"Save"),"."))))))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Remove Nodes")),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"You can start by removing the node configuration from the existing cluster using the ",(0,a.kt)("inlineCode",{parentName:"li"},"Cluster Node")," section in the Platform portal and delete the additional node. Make sure you maintain at least 3 nodes in the cluster for HA ."),(0,a.kt)("li",{parentName:"ul"},"Then you can set the replica count to desired number. For eg if you want to decrease the number of nodes from four nodes to three nodes you can use the following command.\n",(0,a.kt)("inlineCode",{parentName:"li"}," kubectl  scale statefulsets mosquitto --replicas=3 -n <namespace>"))))),(0,a.kt)("h2",m({},{id:"advanced-configuration"}),"Advanced Configuration"),(0,a.kt)("h3",m({},{id:"configurable-mosquitto-broker-settings"}),"Configurable Mosquitto Broker Settings"),(0,a.kt)("p",null,"The Helm chart now supports ",(0,a.kt)("strong",{parentName:"p"},"dynamic configuration")," of the Mosquitto broker through ",(0,a.kt)("inlineCode",{parentName:"p"},"values.yaml"),", eliminating the need to modify and repackage the chart. All broker settings can be configured using ",(0,a.kt)("inlineCode",{parentName:"p"},"--set")," flags during installation or upgrade or directly inside values.yaml file."),(0,a.kt)("h4",m({},{id:"mosquitto-configuration-options"}),(0,a.kt)("strong",{parentName:"h4"},"Mosquitto Configuration Options")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Basic Broker Settings:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.allowAnonymous=<true|false>"),": Allow unauthenticated access. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"true")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.maxQueuedMessages=<number>"),": Maximum queued messages per client. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1000")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.maxInflightMessages=<number>"),": Maximum inflight messages per client. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"100")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.enableDebugLogging=<true|false>"),": Enable debug logging. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"WebSockets Support:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.enableWebsockets=<true|false>"),": Enable WebSockets listener. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.websocketsPort=<port>"),": WebSockets port. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8090"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TLS Configuration:")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"IMPORTANT:")," For High-Availability (HA) deployments, the ",(0,a.kt)("strong",{parentName:"p"},"recommended approach")," is to configure TLS at the ",(0,a.kt)("strong",{parentName:"p"},"HAProxy level")," (TLS termination), not on individual Mosquitto brokers. This provides centralized certificate management and simplifies the HA setup."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HAProxy TLS Configuration (Recommended for HA):")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.tls.enabled=true"),": Enable HAProxy TLS termination. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.tls.secretName=<secret-name>"),": Name of the Secret containing HAProxy TLS certificate (PEM format). Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"haproxy-tls-certs")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.tls.pemFile=<filename>"),": PEM file name (combined cert+key). Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"haproxy_combined.pem")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.tls.pemContent=<base64-content>"),": Base64-encoded PEM content (cert+key combined)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.secureListener=<port>"),": HAProxy secure MQTT port. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8883"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Mosquitto TLS Configuration (Optional, for end-to-end encryption):")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.enableTls=<true|false>"),": Enable TLS listener on Mosquitto. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.tls.enabled=<true|false>"),": Enable TLS certificate mounting. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"false")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.tls.secretName=<secret-name>"),": Name of the Secret containing TLS certificates")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note:")," If using HAProxy TLS termination (recommended), you typically do NOT need to enable Mosquitto TLS unless you require end-to-end encryption between HAProxy and Mosquitto brokers."),(0,a.kt)("h4",m({},{id:"haproxy-configuration-1"}),(0,a.kt)("strong",{parentName:"h4"},"HAProxy Configuration")),(0,a.kt)("p",null,"HAProxy acts as a load balancer in front of the Mosquitto cluster. Below are the key configuration options:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Basic HAProxy Settings:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.replicas=<count>"),": Number of HAProxy replicas for redundancy. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"2")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.serviceType=<type>"),": Service type for HAProxy. Options: ",(0,a.kt)("inlineCode",{parentName:"li"},"LoadBalancer")," (default), ",(0,a.kt)("inlineCode",{parentName:"li"},"NodePort"),", ",(0,a.kt)("inlineCode",{parentName:"li"},"ClusterIP")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.pullPolicy=<policy>"),": Image pull policy for HAProxy. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"Always"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HAProxy Port Configuration:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.listener=<port>"),": MQTT listener port (non-TLS). Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.listenerTarget=<port>"),": Target port on HAProxy container. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"1883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.secureListener=<port>"),": MQTT secure listener port (TLS). Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.secureListenerTarget=<port>"),": Target port for secure connection. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8883")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.ports.stats=<port>"),": HAProxy statistics page port. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"8404"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HAProxy Performance Configuration:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.maxconn=<number>"),": Maximum concurrent connections per HAProxy instance. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"10000"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HAProxy Resource Configuration:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.requests.cpu=<cpu>"),": HAProxy CPU request. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"100m")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.requests.memory=<memory>"),": HAProxy memory request. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"256Mi")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.limits.cpu=<cpu>"),": HAProxy CPU limit. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"500m")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"--set haproxy.resources.limits.memory=<memory>"),": HAProxy memory limit. Default: ",(0,a.kt)("inlineCode",{parentName:"li"},"512Mi"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"HAProxy Configuration File:")),(0,a.kt)("p",null,"The HAProxy configuration is managed via a ConfigMap (",(0,a.kt)("inlineCode",{parentName:"p"},"haproxy-config.yaml"),"). Key sections include:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"DNS Resolution"),": Uses Kubernetes DNS to resolve Mosquitto pod addresses dynamically"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Frontend"),": Defines the MQTT listener (port 1883 for non-TLS, 8883 for TLS)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Backend"),": Load balances across all Mosquitto broker pods with health checks"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Health Checks"),": Monitors broker availability and removes failed brokers from rotation")),(0,a.kt)("p",null,"The default configuration automatically discovers all Mosquitto pods using Kubernetes service discovery."),(0,a.kt)("h4",m({},{id:"plugin-configuration"}),(0,a.kt)("strong",{parentName:"h4"},"Plugin Configuration")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Prometheus Metrics Plugin:")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"--set prometheus.enabled=true \\\n--set mosquitto.config.plugins.prometheusMetrics.enabled=true \\\n--set mosquitto.config.plugins.prometheusMetrics.port=8000 \\\n--set mosquitto.config.plugins.prometheusMetrics.updateInterval=15\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"InfluxDB Metrics Plugin:")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"--set mosquitto.config.plugins.influxdbMetrics.enabled=true \\\n--set mosquitto.config.plugins.influxdbMetrics.host=<influxdb-host> \\\n--set mosquitto.config.plugins.influxdbMetrics.port=8086 \\\n--set mosquitto.config.plugins.influxdbMetrics.database=<db-name>\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Other Plugins:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Data Validation: ",(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.dataValidation.enabled=true")),(0,a.kt)("li",{parentName:"ul"},"LDAP Auth: ",(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.ldap.enabled=true")),(0,a.kt)("li",{parentName:"ul"},"JWT Auth: ",(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.jwt.enabled=true")),(0,a.kt)("li",{parentName:"ul"},"Audit Plugins: ",(0,a.kt)("inlineCode",{parentName:"li"},"--set mosquitto.config.plugins.audit.mqtt5.enabled=true"))),(0,a.kt)("h4",m({},{id:"complete-example-with-custom-configuration"}),(0,a.kt)("strong",{parentName:"h4"},"Complete Example with Custom Configuration")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),'helm install my-ha-cluster mosquitto-3.1-platform-3.1-kubernetes-cluster.tgz -n ha \\\n  --set licenseKey=<your-license-key> \\\n  --set nameserver=10.0.0.10 \\\n  --set storageClass=gp3 \\\n  --set mosquitto.replicas=3 \\\n  --set haproxy.replicas=2 \\\n  --set haproxy.tls.enabled=true \\\n  --set haproxy.tls.pemContent="<base64-encoded-pem>" \\\n  --set mosquitto.config.maxQueuedMessages=5000 \\\n  --set mosquitto.config.maxInflightMessages=200 \\\n  --set mosquitto.config.enableWebsockets=true \\\n  --set prometheus.enabled=true \\\n  --set mosquitto.config.plugins.prometheusMetrics.enabled=true \\\n  --set mosquitto.resources.requests.cpu=500m \\\n  --set mosquitto.resources.requests.memory=1Gi\n')),(0,a.kt)("h4",m({},{id:"updating-configuration-after-installation"}),(0,a.kt)("strong",{parentName:"h4"},"Updating Configuration After Installation")),(0,a.kt)("p",null,"To update the configuration after installation, use ",(0,a.kt)("inlineCode",{parentName:"p"},"helm upgrade"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"# Enable Prometheus monitoring\nhelm upgrade <release-name> mosquitto-3.1-platform-3.1-kubernetes-cluster.tgz -n <namespace> \\\n  --reuse-values \\\n  --set prometheus.enabled=true \\\n  --set mosquitto.config.plugins.prometheusMetrics.enabled=true\n\n# Update max queued messages\nhelm upgrade <release-name> mosquitto-3.1-platform-3.1-kubernetes-cluster.tgz -n <namespace> \\\n  --reuse-values \\\n  --set mosquitto.config.maxQueuedMessages=10000\n")),(0,a.kt)("h3",m({},{id:"prometheus-monitoring-integration"}),"Prometheus Monitoring Integration"),(0,a.kt)("p",null,"The Helm chart includes built-in support for Prometheus monitoring through the Mosquitto Prometheus Metrics plugin and Kubernetes ServiceMonitor."),(0,a.kt)("h4",m({},{id:"prerequisites"}),(0,a.kt)("strong",{parentName:"h4"},"Prerequisites")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"IMPORTANT:")," Before enabling Prometheus monitoring with ServiceMonitor, ensure the ",(0,a.kt)("strong",{parentName:"p"},"Prometheus Operator")," is installed in your cluster. Without it, the Helm installation will fail with an error about missing Custom Resource Definitions (CRDs)."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Install Prometheus Operator (Recommended):")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"# Add Prometheus community Helm repository\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\n# Install kube-prometheus-stack\nhelm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --create-namespace\n\n# Wait for operator readiness\nkubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus-operator -n monitoring --timeout=300s\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Alternative:")," Disable ServiceMonitor if not using Prometheus Operator:"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"--set prometheus.serviceMonitor.enabled=false\n")),(0,a.kt)("h4",m({},{id:"configuration-for-ha-cluster"}),(0,a.kt)("strong",{parentName:"h4"},"Configuration for HA Cluster")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Full Prometheus Integration:")),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),'helm install my-ha-cluster mosquitto-3.1-platform-3.1-kubernetes-cluster.tgz -n ha \\\n  --set licenseKey=<your-license-key> \\\n  --set nameserver=10.0.0.10 \\\n  --set prometheus.enabled=true \\\n  --set prometheus.serviceMonitor.enabled=true \\\n  --set mosquitto.config.plugins.prometheusMetrics.enabled=true \\\n  --set mosquitto.config.plugins.prometheusMetrics.bindAddress="0.0.0.0"\n')),(0,a.kt)("h4",m({},{id:"verifying-prometheus-integration"}),(0,a.kt)("strong",{parentName:"h4"},"Verifying Prometheus Integration")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Check ServiceMonitor:")),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"kubectl get servicemonitor -n <namespace>\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"Check Prometheus targets:")),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090\n# Open http://localhost:9090/targets - should see all 3 Mosquitto pods\n")))),(0,a.kt)("h4",m({},{id:"troubleshooting"}),(0,a.kt)("strong",{parentName:"h4"},"Troubleshooting")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},'Error: "no matches for kind ServiceMonitor"')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Solution:")," Install ",(0,a.kt)("inlineCode",{parentName:"li"},"kube-prometheus-stack")," or disable with ",(0,a.kt)("inlineCode",{parentName:"li"},"--set prometheus.serviceMonitor.enabled=false"))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Not all broker replicas showing in Prometheus")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Cause:")," ServiceMonitor selector or endpoint configuration issue"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Solution:")," Verify all Mosquitto pods are running and metrics port is accessible")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Metrics endpoint returns 404")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Solution:")," Ensure ",(0,a.kt)("inlineCode",{parentName:"li"},'mosquitto.config.plugins.prometheusMetrics.bindAddress="0.0.0.0"'))),(0,a.kt)("p",null,"Access metrics endpoint at: ",(0,a.kt)("inlineCode",{parentName:"p"},"http://<mosquitto-pod-name>:8000/metrics")),(0,a.kt)("h2",m({},{id:"networkpolicy-security-optional"}),"NetworkPolicy Security (Optional)"),(0,a.kt)("p",null,"For enhanced security, you can enable NetworkPolicies to control traffic flow between pods. This restricts network access to only necessary connections."),(0,a.kt)("h3",m({},{id:"prerequisites-1"}),"Prerequisites"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"CNI Plugin"),": Your cluster must support NetworkPolicies (Calico, Cilium, Weave Net, etc.)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"NetworkPolicy Support"),": Verify with ",(0,a.kt)("inlineCode",{parentName:"li"},"kubectl get crd networkpolicies.networking.k8s.io"))),(0,a.kt)("h3",m({},{id:"enable-networkpolicies"}),"Enable NetworkPolicies"),(0,a.kt)("p",null,"Add the following to your Helm installation:"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"--set networkPolicy.enabled=true\n")),(0,a.kt)("h3",m({},{id:"dns-configuration-configurable"}),"DNS Configuration (Configurable)"),(0,a.kt)("p",null,"NetworkPolicies require DNS resolution to work properly. The Helm chart includes configurable DNS settings that automatically adapt to different cluster environments:"),(0,a.kt)("h4",m({},{id:"default-configuration-standard-kubernetes"}),"Default Configuration (Standard Kubernetes)"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-yaml"}),'networkPolicy:\n  enabled: true\n  dns:\n    namespace: "kube-system"\n    podSelector:\n      key: "k8s-app"\n      value: "coredns"\n    ports:\n      udp: 53\n      tcp: 53\n')),(0,a.kt)("h4",m({},{id:"custom-dns-configuration"}),"Custom DNS Configuration"),(0,a.kt)("p",null,"For non-standard clusters, you can customize DNS settings:"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"helm install mosquitto-ha . -n <namespace> \\\n  --set networkPolicy.enabled=true \\\n  --set networkPolicy.dns.namespace=<dns-namespace> \\\n  --set networkPolicy.dns.podSelector.key=<selector-key> \\\n  --set networkPolicy.dns.podSelector.value=<selector-value> \\\n  --set networkPolicy.dns.ports.udp=<dns-udp-port> \\\n  --set networkPolicy.dns.ports.tcp=<dns-tcp-port>\n")),(0,a.kt)("h4",m({},{id:"detect-dns-configuration"}),"Detect DNS Configuration"),(0,a.kt)("p",null,"Use these commands to find your cluster's DNS configuration:"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),"# Find DNS namespace\nkubectl get pods --all-namespaces | grep -E 'dns|core-dns'\n\n# Find DNS pod labels\nkubectl get pods -n kube-system --show-labels | grep -E 'dns|coredns'\nkubectl get pods -n openshift-dns --show-labels | grep dns\n\n# Find DNS service ports\nkubectl describe svc kube-dns -n kube-system | grep -A 5 \"Port:\"\nkubectl describe svc coredns -n kube-system | grep -A 5 \"Port:\"\n")),(0,a.kt)("h3",m({},{id:"what-networkpolicies-control"}),"What NetworkPolicies Control"),(0,a.kt)("p",null,"The Helm chart creates 5 NetworkPolicy resources:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"Mosquitto NetworkPolicy"),": Controls MQTT traffic (1888), admin access (1885), Raft communication (7000), and create-cluster job access"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"HAProxy NetworkPolicy"),": Manages external MQTT connections (1883/8883) and backend communication"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"Platform NetworkPolicy"),": Controls web UI access (3000/443) and MQTT operations"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"Cluster Setup NetworkPolicy"),": Allows cluster initialization job to communicate with brokers"),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("strong",{parentName:"li"},"Image Registry Policy"),": Permits image pulls from ",(0,a.kt)("inlineCode",{parentName:"li"},"registry.cedalo.com"))),(0,a.kt)("h3",m({},{id:"create-cluster-job-support"}),"Create-Cluster Job Support"),(0,a.kt)("p",null,"For high availability deployments, the ",(0,a.kt)("inlineCode",{parentName:"p"},"create-cluster")," job requires specific network access:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Port 1885"),": Admin access to Mosquitto brokers for cluster initialization"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"DNS Resolution"),": Required for service discovery during cluster formation")),(0,a.kt)("p",null,"The Mosquitto NetworkPolicy automatically includes ingress rules for the create-cluster job."),(0,a.kt)("h3",m({},{id:"verification"}),"Verification"),(0,a.kt)("pre",null,(0,a.kt)("code",m({parentName:"pre"},{className:"language-bash"}),'# Check NetworkPolicies are created\nkubectl get networkpolicies -n <namespace>\n\n# Test connectivity (should work normally)\nkubectl exec -it <mosquitto-pod> -- mosquitto_pub -h localhost -t test -m "hello"\n\n# Test DNS resolution from platform pod\nkubectl exec -it <platform-pod> -- nslookup mosquitto-0.mosquitto.ha.svc.cluster.local\n\n# Check create-cluster job logs\nkubectl logs -l job-name=create-cluster -n <namespace>\n')),(0,a.kt)("h3",m({},{id:"important-notes"}),"Important Notes"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Default Behavior"),": Without NetworkPolicies, all pods can communicate freely"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"CNI Requirement"),": NetworkPolicies only work with compatible CNI plugins"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"DNS Dependency"),": NetworkPolicies require proper DNS configuration for service discovery"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Standard Kubernetes DNS"),": Uses port 53 (UDP/TCP)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Troubleshooting"),": If connectivity issues occur, disable with ",(0,a.kt)("inlineCode",{parentName:"li"},"--set networkPolicy.enabled=false"))),(0,a.kt)("p",null,"For detailed NetworkPolicy documentation, see the ",(0,a.kt)("inlineCode",{parentName:"p"},"NETWORK-POLICY.md")," file in the Helm chart directory."),(0,a.kt)("h2",m({},{id:"connect-to-cluster"}),"Connect to cluster"),(0,a.kt)("p",null,"Once your setup is ready, you can access the mosquitto brokers using the external ip of the haproxy service deployed to connect to the cluster from the outside world.\nGo to the ",(0,a.kt)("inlineCode",{parentName:"p"},"Client Account"),' menu and create a new client to connect from. Make sure to assign a role, like the default "client" role, to allow your client to publish and/or subscribe to topics.\nNow you can connect to the Mosquitto cluster. You can access it either with connecting it directly to worker node running the haproxy pod along with a service exposed at port 1883:'),(0,a.kt)("p",null,"To get the external ip of HAproxy service:\n",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl get service haproxy -n <namespace>")),(0,a.kt)("p",null,"In this example command we use Mosquitto Sub to subscribe onto all topics:\n",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto_sub -h <external-ip-of-haproxy> -p 1883 -u <username> -P <password> -t '#'")),(0,a.kt)("p",null,"Make sure to replace your IP, username and password."),(0,a.kt)("h2",m({},{id:"usage"}),"Usage"),(0,a.kt)("p",null,"Once the installation is complete, you can start using the multi-node Mosquitto broker. Be sure to check the Mosquitto documentation for further details on configuring and using the broker"))}f.isMDXComponent=!0}}]);