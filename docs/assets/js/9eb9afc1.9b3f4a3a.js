"use strict";(self.webpackChunkstreamsheets=self.webpackChunkstreamsheets||[]).push([[19207],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return u}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var o=a.createContext({}),m=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=m(e.components);return a.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=m(n),u=i,h=c["".concat(o,".").concat(u)]||c[u]||d[u]||r;return n?a.createElement(h,l(l({ref:t},p),{},{components:n})):a.createElement(h,l({ref:t},p))}));function u(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,l=new Array(r);l[0]=c;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:i,l[1]=s;for(var m=2;m<r;m++)l[m]=n[m];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},7904:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return o},metadata:function(){return m},toc:function(){return p},default:function(){return c}});var a=n(87462),i=n(63366),r=(n(67294),n(3905)),l=["components"],s={id:"mosquitto-streams",title:"Streams",sidebar_label:"Streams"},o="Cedalo Stream Processing plugin for Eclipse Mosquitto",m={unversionedId:"mosquitto-streams",id:"mosquitto-streams",title:"Streams",description:"star This is a [Mosquitto",source:"@site/mosquitto/streams.md",sourceDirName:".",slug:"/mosquitto-streams",permalink:"/mosquitto/2.0/mosquitto-streams",tags:[],version:"current",frontMatter:{id:"mosquitto-streams",title:"Streams",sidebar_label:"Streams"},sidebar:"someSidebar",previous:{title:"Dynamic security",permalink:"/mosquitto/2.0/broker-dynamic-security"},next:{title:"Mosquitto",permalink:"/mosquitto/2.0/manpage-mosquitto"}},p=[{value:"Quick start",id:"quick-start",children:[],level:2},{value:"Stream processing",id:"stream-processing",children:[{value:"Modifying the payload with select statements",id:"modifying-the-payload-with-select-statements",children:[{value:"Basic payload manipulation",id:"basic-payload-manipulation",children:[],level:4},{value:"Select Aliases",id:"select-aliases",children:[],level:4},{value:"Aggregate functions",id:"aggregate-functions",children:[],level:4}],level:3},{value:"Choosing messages are used with where statements",id:"choosing-messages-are-used-with-where-statements",children:[],level:3}],level:2},{value:"Stream persistence and replay",id:"stream-persistence-and-replay",children:[{value:"Replaying",id:"replaying",children:[],level:3},{value:"Message count",id:"message-count",children:[],level:3},{value:"Clearing messages",id:"clearing-messages",children:[],level:3},{value:"Time to Live (TTL)",id:"time-to-live-ttl",children:[],level:3}],level:2},{value:"API description",id:"api-description",children:[{value:"clearStreamMessages",id:"clearstreammessages",children:[],level:3},{value:"createStream and modifyStream",id:"createstream-and-modifystream",children:[],level:3},{value:"deleteStream",id:"deletestream",children:[],level:3},{value:"disableStream",id:"disablestream",children:[],level:3},{value:"enableStream",id:"enablestream",children:[],level:3},{value:"getLicense",id:"getlicense",children:[],level:3},{value:"getStream",id:"getstream",children:[],level:3},{value:"getStreamMessageCount",id:"getstreammessagecount",children:[],level:3},{value:"listStreams",id:"liststreams",children:[],level:3},{value:"replayStream",id:"replaystream",children:[],level:3},{value:"stopStreamReplay",id:"stopstreamreplay",children:[],level:3}],level:2}],d={toc:p};function c(e){var t=e.components,s=(0,i.Z)(e,l);return(0,r.kt)("wrapper",(0,a.Z)({},d,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"cedalo-stream-processing-plugin-for-eclipse-mosquitto"},"Cedalo Stream Processing plugin for Eclipse Mosquitto"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"star",src:n(37393).Z,width:"24",height:"24"})," This is a ",(0,r.kt)("a",{parentName:"p",href:"https://cedalo.com/get-started-with-cedalo-real-time-platform/"},"Mosquitto\nPremium")," feature."),(0,r.kt)("p",null,"The Cedalo Stream Processing (CSP) plugin allows the creation of topic streams in the\nMosquitto broker. A topic stream receives all messages on a specified topic\nand can then perform the following tasks:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Republish messages on a different topic, with optional QoS and retain control"),(0,r.kt)("li",{parentName:"ul"},"Persist messages to disk, with the ability to replay messages in the future"),(0,r.kt)("li",{parentName:"ul"},"Process JSON payload to extract particular data values prior to republishing"),(0,r.kt)("li",{parentName:"ul"},"Apply aggregation functions to data prior to republishing/persisting"),(0,r.kt)("li",{parentName:"ul"},"Select which messages are processed/persisted based on data values in the payload")),(0,r.kt)("p",null,"Controlling the plugin is carried out with an MQTT topic based API. The\nManagement Center for Mosquitto web tool provides a convenient front end to\naccess the API, the mosquitto_ctrl tool provides command line access to the\nAPI, or custom tools can be written to control it."),(0,r.kt)("h2",{id:"quick-start"},"Quick start"),(0,r.kt)("p",null,"After installing the Cedalo Platform Docker image, the Mosquitto\nconfiguration file must be edited to enable the CSP plugin."),(0,r.kt)("p",null,"Edit ",(0,r.kt)("inlineCode",{parentName:"p"},"cedalo_platform/mosquitto/config/mosquitto.conf"),", and add the following\nlines:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"plugin /usr/lib/cedalo_stream_processing.so\nplugin_opt_data_dir /mosquitto/data/csp\n")),(0,r.kt)("p",null,"Place your license file at ",(0,r.kt)("inlineCode",{parentName:"p"},"cedalo_platform/mosquitto/data/csp/license.lic"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note")," it is important to restrict access to the\n",(0,r.kt)("inlineCode",{parentName:"p"},"$CONTROL/stream-processing/v1/#")," topic hierarchy to authorised users."),(0,r.kt)("p",null,"Start Mosquitto using ",(0,r.kt)("inlineCode",{parentName:"p"},"start.sh")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"start.bat")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"cedalo_platform"),"\ndirectory. The logs should show license information:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"CSP: Cedalo Streaming Plugin initializing.\nCSP: License serial: decc1940-a806-11eb-ac1e-9d31c1d948ef\nCSP: License issued by: Cedalo AG\nCSP: License issued to: ",(0,r.kt)("a",{parentName:"p",href:"mailto:info@cedalo.com"},"info@cedalo.com"),"\nCSP: License comment: This is a demo license.\nCSP: Licensed stream count: 5 AVAILABLE until 2022-04-28T10:48:22\nCSP: Processing AVAILABLE until 2022-04-28T10:48:22\nCSP: Persistence AVAILABLE until 2022-04-28T10:48:22")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Changing the configuration is only necessary, if you want to switch from an existing open source installation to a premium version."))),(0,r.kt)("h2",{id:"stream-processing"},"Stream processing"),(0,r.kt)("p",null,"The stream processing feature allows messages with JSON payloads to be modified\nbefore they are republished and/or persisted to disk. This is managed with a\nuser defined query that has similar concepts to a SQL statement."),(0,r.kt)("h3",{id:"modifying-the-payload-with-select-statements"},"Modifying the payload with select statements"),(0,r.kt)("p",null,"When processing is enabled the JSON payload can be manipulated using ",(0,r.kt)("inlineCode",{parentName:"p"},"select"),"\nstatements. If no select statements are defined, then the payload will be left\nunmodified. If select statements are defined, then only the parts of the\nmessage that are defined in the select will be added to the outgoing payload,\nand only messages that match the select specification will be republished or\npersisted."),(0,r.kt)("p",null,"The following examples demonstrate how to use define the ",(0,r.kt)("inlineCode",{parentName:"p"},"select")," queries.\nOnly the ",(0,r.kt)("inlineCode",{parentName:"p"},"select")," part of the command payload is shown, see the ",(0,r.kt)("inlineCode",{parentName:"p"},"createStream"),"\ncommand for the full command payload requirement."),(0,r.kt)("p",null,"The example incoming payload is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},' {\n    "Machine Data": {\n        "Speed": 7.5,\n        "Angle Deg": 55.3,\n        "Angle Rad": 0.97,\n        "Power": 601.6\n    },\n    "Location": "Freiburg"\n}\n')),(0,r.kt)("p",null,"A basic select picks a JSON object from the source payload and optionally\nplaces it in the target payload. To access items in the JSON object each\nelement of the object hierarchy is described by the object name in square\nbrackets. For example, to select the Speed element the ",(0,r.kt)("inlineCode",{parentName:"p"},"source")," item would be\nset to ",(0,r.kt)("inlineCode",{parentName:"p"},"[Machine Data][Speed]"),". The same technique is used when choosing the\ntarget location. It is perfectly valid to have the source and target paths be\nthe same."),(0,r.kt)("h4",{id:"basic-payload-manipulation"},"Basic payload manipulation"),(0,r.kt)("p",null,"This example extracts the Speed and makes it a top level object, keeps the\nLocation and discards all other payload entries."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"select": [\n    {\n        "source": "[Machine Data][Speed]",\n        "target": "[Speed]"\n    },{\n        "source": "[Location]",\n        "target": "[Location]\n    }\n]\n')),(0,r.kt)("p",null,"With the example payload this would result in the following output payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "Speed": 7.5,\n    "Location": "Freiburg"\n}\n')),(0,r.kt)("h4",{id:"select-aliases"},"Select Aliases"),(0,r.kt)("p",null,"When defining a ",(0,r.kt)("inlineCode",{parentName:"p"},"select")," statement an ",(0,r.kt)("inlineCode",{parentName:"p"},"alias")," can be created. This is a text\nstring, that must not begin or end with a square bracket, that can be used is a\n",(0,r.kt)("inlineCode",{parentName:"p"},"where")," statement instead of the full JSON path."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"select": [\n    {\n        "source": "[Machine Data][Speed]",\n        "target": "[Speed]"\n    },{\n        "source": "[Location]",\n        "target": "[Location],\n        "alias": "location"\n    }\n]\n')),(0,r.kt)("h4",{id:"aggregate-functions"},"Aggregate functions"),(0,r.kt)("p",null,"Simple time aggregations can be defined for select statements for calculations\nover a time bucket. This includes the ",(0,r.kt)("inlineCode",{parentName:"p"},"min"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"max"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"sum"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"count"),", and\n",(0,r.kt)("inlineCode",{parentName:"p"},"time_bucket")," functions. When a function is defined, the current values for\neach select statement is stored, and when a message is received, the payload is\nused to calculate the new value depending on the function in use. A new message\nwill be republished/persisted for every message that is received, and will\ncontain the current values. The current time bucket can be added to the target\npayload for identifying which bucket a message is in."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"time_bucket")," function defines the parameters of the time bucket to be\nused. It has the parameters ",(0,r.kt)("inlineCode",{parentName:"p"},"intervalsize")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"intervaloffset"),", which are both\nin seconds. ",(0,r.kt)("inlineCode",{parentName:"p"},"intervalsize")," defines the length of the time bucket and must be\ngreater than 0. ",(0,r.kt)("inlineCode",{parentName:"p"},"intervaloffset")," defines the start offset of the time bucket.\nSo to create a 60 second time interval that starts at 15 seconds into the\nminute you would use:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"select": [\n    {\n        "source": "", # source is ignored for the time_bucket function\n        "target": "", # set to a JSON path to output to the payload, or blank to ignore\n        "function": {\n            "name": "time_bucket",\n            "intervalsize": 60,\n            "intervaloffset": 15\n        }\n    }\n]\n')),(0,r.kt)("p",null,"Only one ",(0,r.kt)("inlineCode",{parentName:"p"},"time_bucket")," is allowed per query. The other functions are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"max")," : the maximum value in the time bucket"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"min")," : the minimum value in the time bucket"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sum")," : the sum of all values in the time bucket"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"count")," : the count of messages received in the time bucket. This function\ndoes not require a source.")),(0,r.kt)("p",null,"A more complete example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"select": [\n    {\n        "source": "[Machine Data][Speed]",\n        "target": "[Data][SpeedMax]",\n        "alias" : "speedmax",\n        "function": {\n            "name" : "max"\n        }\n    },\n    {\n        "source": "[Machine Data][Power]",\n        "target": "[Data][PowerSum]",\n        "alias" : "powersum",\n        "function": {\n            "name" : "sum"\n        }\n\n    },\n    {\n        "target": "[Data][Count]",\n        "alias" : "IntervalCount",\n        "function": {\n            "name" : "count"\n        }\n\n    },\n    {\n        "source": "*",\n        "target": "",\n        "alias" : "timeInterval",\n        "function": {\n            "name" : "time_bucket",\n            "intervalsize": 60,\n            "intervaloffset": 30\n        }\n    },\n    {\n        "source": "[Location]",\n        "target": "[Location]",\n        "alias" : "Location"\n    }\n]\n')),(0,r.kt)("p",null,"This would produce the output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "Data" {\n        "SpeedMax": 10,\n        "PowerSum": 123,\n        "Count": 3\n    },\n    "Location": "Freiburg"\n}\n')),(0,r.kt)("p",null,"The processing feature has some internal sources that can be used:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"timestamp")," : the current Unix timestamp in seconds"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"windowstart")," : the start of the current time bucket, if enabled"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"windowend")," : the end of the current time bucket, if enabled")),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"select": [\n    {\n        "source": "timestamp",\n        "target": "[Data][Now]",\n    }\n]\n')),(0,r.kt)("h3",{id:"choosing-messages-are-used-with-where-statements"},"Choosing messages are used with where statements"),(0,r.kt)("p",null,"It is possible to restrict which messages are processed and persisted by using\na ",(0,r.kt)("inlineCode",{parentName:"p"},"where")," statement. The "),(0,r.kt)("h2",{id:"stream-persistence-and-replay"},"Stream persistence and replay"),(0,r.kt)("p",null,"The stream persistence feature allows all messages received on a stream to be\nsaved to disk and then replayed to a new topic at a later point in time.\nPersistence can be turned on or off at any point for any stream, if the feature\nis available."),(0,r.kt)("p",null,"When used on a stream that has processing configured, the processed payload\nwill be stored not the original payload."),(0,r.kt)("p",null,"Stream persistence is not available for 32-bit platforms."),(0,r.kt)("h3",{id:"replaying"},"Replaying"),(0,r.kt)("p",null,"Replaying a stream means republishing its messages on a different topic. A\nsingle replay may be running for each stream at once."),(0,r.kt)("p",null,"To replay a stream, use the ",(0,r.kt)("inlineCode",{parentName:"p"},"replayStream")," command. The only requirement for is\nto specify the destination topic. Further control is possible using the ",(0,r.kt)("inlineCode",{parentName:"p"},"gte"),",\n",(0,r.kt)("inlineCode",{parentName:"p"},"lte"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"limit"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"speed"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"reverse")," parameters."),(0,r.kt)("p",null,"If only the ",(0,r.kt)("inlineCode",{parentName:"p"},"replaytopic")," parameter is provided, all of the messages stored for\nthe stream will be republished in order, with the first message published\nimmediately and subsequent messages published at approximately the same\ninterval as the original messages."),(0,r.kt)("p",null,"The range and number of messages to be replayed can be limited using ",(0,r.kt)("inlineCode",{parentName:"p"},"gte"),",\n",(0,r.kt)("inlineCode",{parentName:"p"},"lte"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"limit"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"gte")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"lte"),' are the lower and upper bounds of the time\nrange that should be replayed, respectively. They are both Unix timestamps in\nseconds. Both are optional, so specifying a range "all messages up to this\npoint" or "all messages since this point" are both possible, as well as "only\nmessages within this range". The ',(0,r.kt)("inlineCode",{parentName:"p"},"limit")," parameter limits the total number of\nmessages that will be replayed, and can be used in conjunction with ",(0,r.kt)("inlineCode",{parentName:"p"},"gte"),"\nand/or ",(0,r.kt)("inlineCode",{parentName:"p"},"lte"),", or on its own. The default value of -1 means there is no\nnumerical limit."),(0,r.kt)("p",null,"The speed of the replay can be controlled using the ",(0,r.kt)("inlineCode",{parentName:"p"},"speed"),' parameter. Set to\nthe string "original" to keep the original speed, or to "fastest" to be\nrepublished at the fastest rate possible. Alternatively, set to a number to\nspecify an exact speed multiple, e.g. setting to ',(0,r.kt)("inlineCode",{parentName:"p"},"2.5")," would replay the stream\n2.5x faster than the original."),(0,r.kt)("p",null,"Stopping an in-progress replay for a stream can be done using the\n",(0,r.kt)("inlineCode",{parentName:"p"},"stopStreamReplay")," command."),(0,r.kt)("h3",{id:"message-count"},"Message count"),(0,r.kt)("p",null,"It is possible to obtain the estimated number of message currently persisted\nusing the ",(0,r.kt)("inlineCode",{parentName:"p"},"getStreamMessageCount")," command."),(0,r.kt)("h3",{id:"clearing-messages"},"Clearing messages"),(0,r.kt)("p",null,"Persisted messages can be manually cleared using the ",(0,r.kt)("inlineCode",{parentName:"p"},"clearStreamMessages")," API\ncommand. This completely removes the messages from disk and can not be undone."),(0,r.kt)("p",null,"All messages can be cleared, or a range of messages can be cleared based on\nthe message timestamp in unix timestamp seconds format. Use the ",(0,r.kt)("inlineCode",{parentName:"p"},"gte")," parameter\nto specify the lower bound of the timestamp that will be cleared, and the ",(0,r.kt)("inlineCode",{parentName:"p"},"lte"),"\nparameter to specify the upper bound of the range to be cleared."),(0,r.kt)("p",null,"See the API description for details of ",(0,r.kt)("inlineCode",{parentName:"p"},"gte")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"lte"),"."),(0,r.kt)("h3",{id:"time-to-live-ttl"},"Time to Live (TTL)"),(0,r.kt)("p",null,"When creating a new stream and enabling persistence, the Time to Live (TTL)\nproperty will be used, which allows the disk usage of streams to be limited.\nSetting TTL to 0 means that all messages received will be kept on disk forever,\nunless they are manually cleared. Setting TTL to a positive integer means that\nmessages will be removed from the persistence store in the future. TTL is\nmeasured in seconds, and guarantees that messages that are younger than that\nnumber of seconds will be kept in the database. Messages older than the TTL\ninterval are not immediately removed from the database: they can remain in the\ndatabase until at most twice the TTL interval before they are removed,\ndepending on when they were received."),(0,r.kt)("h2",{id:"api-description"},"API description"),(0,r.kt)("p",null,"The CSP plugin is controlled over the ",(0,r.kt)("inlineCode",{parentName:"p"},"$CONTROL/stream-processing/v1")," topic, with\nreplies published to ",(0,r.kt)("inlineCode",{parentName:"p"},"$CONTROL/stream-processing/v1/response"),". You should ensure that\nyour access control solution denies access to these topics for unauthorized\nusers."),(0,r.kt)("p",null,"Commands are sent as JSON payloads, as described in the command sections below.\nThe examples in each section show only a single command in the command array,\nbut multiple commands can be sent at once and will be processed in order."),(0,r.kt)("p",null,"Commands will generate a response on the response topic. Unless otherwise\nspecified, this will consist of the ",(0,r.kt)("inlineCode",{parentName:"p"},"command")," string, the optional\n",(0,r.kt)("inlineCode",{parentName:"p"},"correlationData")," string, and an ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," string. If the command completed\nsuccessfully, the ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," string will not be present. Where a command returns\ndata in the response there will be a ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," object with contents as described\nin the individual command sections."),(0,r.kt)("p",null,"Response payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "responses":[\n        {\n            "command": "getStreamMessageCount",\n            "correlationData": "3c079967-5bee-4409-aa9f-a963180cde94",\n            "error": "Persistence not configured for this stream"\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"clearstreammessages"},"clearStreamMessages"),(0,r.kt)("p",null,"Clear persisted messages within a defined range."),(0,r.kt)("p",null,"Parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"streamname")," : the name of the stream to be cleared."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"gte"),' : optional lower bound of the range to be cleared, i.e. all messages\nmore recent than this will be cleared. If not present or set to "", then no\nlower bound will be used. Unix timestamp in seconds.'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"lte"),' : optional upper bound of the range to be cleared, i.e. all messages\nolder than this will be cleared. If not present or set to "", then no upper\nbound will be used. Unix timestamp in seconds.'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value.")),(0,r.kt)("p",null,"Non-code examples:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# Clear all messages that are more recent than 1620131088.\nclearStreamMessages gte=1620131088\n\n# Clear all messages that are older than 1620131088.\nclearStreamMessages lte=1620131088\n\n# Clear all messages that are more recent than 1620044688 and are also older\n# than 1620131088.\nclearStreamMessages gte=1620044688 lte=1620131088\n")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "clearStreamMessages",\n            "streamname": "<name of stream>",\n            "gte": <optional lower bound as unix timestamp number>,\n            "lte": <optional upper bound as unix timestamp number>,\n            "correlationData": ""\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"createstream-and-modifystream"},"createStream and modifyStream"),(0,r.kt)("p",null,"Create a new stream, or modify an existing stream."),(0,r.kt)("p",null,"When modifying a stream, only parameters that are present in the JSON payload\nare updated."),(0,r.kt)("p",null,"Parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"streamname")," : the name of the stream to be created/modified."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sourcetopic")," : the MQTT topic that will be used as the source of messages."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"targettopic")," : optional MQTT topic where stream messages will be\nrepublished."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"targetqos")," : optional QoS that will be used when republishing messages. If\nset to -1 then the original QoS will be used."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ttl")," : optional Time to Live in seconds that will be used when persisting\nmessages."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"active")," : boolean, if set to true the stream will be enabled and\noperational. If set to false, none of the stream features will be used."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"process")," : boolean, if set to true the stream processing feature will be\nenabled. If set to false, stream processing will be disabled and payloads\nwill be republished without modification."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"persist")," : boolean, if set to true the stream persistence feature will be\nenabled. If set to false, stream persistence will be disabled and messages\nwill not be persisted to disk."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"textname")," : optional user string to name the stream."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"textdescription")," : optional user string to describe the stream."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"query")," : optional object used with the processing feature, can contain a\n",(0,r.kt)("inlineCode",{parentName:"li"},"select")," and/or a ",(0,r.kt)("inlineCode",{parentName:"li"},"where")," array."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"select")," : optional query array "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"where")," : optional query array. At the moment this array can only contain a\nsingle object with an ",(0,r.kt)("inlineCode",{parentName:"li"},"operator"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"left"),", and ",(0,r.kt)("inlineCode",{parentName:"li"},"right")," members. The ",(0,r.kt)("inlineCode",{parentName:"li"},"left"),"\nstring is a JSON path field or alias. The ",(0,r.kt)("inlineCode",{parentName:"li"},"right")," item can only be a value\nand can be a string, number, or boolean. The ",(0,r.kt)("inlineCode",{parentName:"li"},"operator")," is a string which can\nbe one of ",(0,r.kt)("inlineCode",{parentName:"li"},"=="),", ",(0,r.kt)("inlineCode",{parentName:"li"},"!="),", ",(0,r.kt)("inlineCode",{parentName:"li"},">"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"<"),", ",(0,r.kt)("inlineCode",{parentName:"li"},">="),", or ",(0,r.kt)("inlineCode",{parentName:"li"},"<="),".")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "createStream",\n            "streamname": "<name>",\n            "correlationData": "",\n            "sourcetopic": "",\n            "targettopic": "",\n            "targetqos": -1|0|1|2,\n            "ttl": 86400,\n            "active": true|false,\n            "process": true|false,\n            "persist": true|false,\n            "textname": "",\n            "textdescription": "",\n            "query": {\n                "select": [\n                    {\n                        "source": "",\n                        "target": "",\n                        "alias": "",\n                        "function": {\n                            "name": ""\n                        }\n                    }\n                ],\n                "where": [\n                    {\n                        "operator": "==",\n                        "left": "",\n                        "right: ""\n                    }\n                ]\n\n            }\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"deletestream"},"deleteStream"),(0,r.kt)("p",null,"Delete a stream. This cannot be undone. If the stream is currently carrying out\na replay, the replay will be stopped."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"streamname")," : the name of the stream to be deleted."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value.")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "deleteStream",\n            "streamname": "<name of stream>",\n            "correlationData": ""\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"disablestream"},"disableStream"),(0,r.kt)("p",null,"Disable an existing stream. Enabling / setting active here means that the stream\nwill accept messages and process, persist, and republish them as it is\nconfigured. If a stream is disabled / set inactive then it will not process,\npersist, or republish messages."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"streamname")," : the name of the stream to be disabled."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value.")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "disableStream",\n            "streamname": "<name of stream>",\n            "correlationData": ""\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"enablestream"},"enableStream"),(0,r.kt)("p",null,"Enable an existing stream. Enabling / setting active here means that the stream\nwill accept messages and process, persist, and republish them as it is\nconfigured. If a stream is disabled / set inactive then it will not process,\npersist, or republish messages."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"streamname")," : the name of the stream to be enabled."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value.")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "enableStream",\n            "streamname": "<name of stream>",\n            "correlationData": ""\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"getlicense"},"getLicense"),(0,r.kt)("p",null,"Retrieve the current licensed features."),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "getLicense",\n            "correlationData": ""\n        }\n    ]\n}\n')),(0,r.kt)("p",null,"Response payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "responses":[\n        {\n            "command": "getLicense",\n            "correlationData": "",\n            "data": {\n                "issuedBy": "Cedalo AG",\n                "issuedTo": "name@customer.com",\n                "comment": "Comment",\n                "serial": "00000000-0000-0000-0000-000000000000",\n                "features": [\n                    {\n                        "name": "stream-count",\n                        "version": "1.0",\n                        "validSince": 1610219382000,\n                        "validUntil": 1610305782000,\n                        "count": -1\n                    },\n                    {\n                        "name": "stream-processing",\n                        "version": "1.0",\n                        "validSince": 1610219382000,\n                        "validUntil": 1610305782000\n                    },\n                    {\n                        "name": "stream-persistence",\n                        "version": "1.0",\n                        "validSince": 1610219382000,\n                        "validUntil": 1610305782000\n                    }\n                ]\n            }\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"getstream"},"getStream"),(0,r.kt)("p",null,"Get information on a stream. "),(0,r.kt)("p",null,"Parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"streamname")," : the name of the stream to be queried."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value.")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "getStream",\n            "streamname": "<name>",\n            "correlationData": ""\n        }\n    ]\n}\n')),(0,r.kt)("p",null,"Response payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "responses":[\n        {\n            "command": "getStream",\n            "correlationData": "",\n            "data": {\n                "streamname": "<name>",\n                "sourcetopic": "",\n                "targettopic": "",\n                "textname": "",\n                "textdescription": "",\n                "targetqos": -1,\n                "ttl": 86400,\n                "active": true|false,\n                "process": true|false,\n                "persist": true|false,\n                "replaying": true|false,\n                "query": {\n                    # Query spec\n                }\n            }\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"getstreammessagecount"},"getStreamMessageCount"),(0,r.kt)("p",null,"Retrieve the approximate count of messages that are currently persisted."),(0,r.kt)("p",null,"Parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"streamname")," : the name of the stream to be queried."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value.")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "getStreamMessageCount",\n            "streamname": "<name of stream>",\n            "correlationData": ""\n        }\n    ]\n}\n')),(0,r.kt)("p",null,"Response payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "responses":[\n        {\n            "command": "getStreamMessageCount",\n            "correlationData": "",\n            "data": {\n                "streamname": "<name of stream>",\n                "count": <count>\n            }\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"liststreams"},"listStreams"),(0,r.kt)("p",null,"List all configured streams."),(0,r.kt)("p",null,"Parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"verbose")," : boolean, if set to false a simple list of stream names will be\nreturned. If set to true, the list of streams will be returned as objects in\nthe same format as when using the ",(0,r.kt)("inlineCode",{parentName:"li"},"getStream")," command."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"count")," : optional maximum number of streams to return."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"offset")," : optional offset to start the stream list."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value.")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "listStreams",\n            "streamname": "<name>",\n            "verbose": true|false,\n            "count": <number>,\n            "offset": <number>\n            "correlationData": ""\n        }\n    ]\n}\n')),(0,r.kt)("p",null,"Response payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "responses":[\n        {\n            "command": "listStreams",\n            "correlationData": "",\n            "data": {\n                "streamname": "<name>",\n                "sourcetopic": "",\n                "targettopic": "",\n                "textname": "",\n                "textdescription": "",\n                "targetqos": -1|0|1|2,\n                "ttl": 86400,\n                "active": true|false,\n                "process": true|false,\n                "persist": true|false,\n                "replaying": true|false,\n                "query": {\n                    # Query spec\n                }\n            }\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"replaystream"},"replayStream"),(0,r.kt)("p",null,"Replay a persisted stream to a different topic."),(0,r.kt)("p",null,"Parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"streamname")," : the name of the stream to be replayed."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"replaytopic")," : The topic where the messages will be published."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"gte"),' : optional lower bound of the range to be cleared, i.e. all messages\nmore recent than this will be replayed. If not present or set to "", then no\nlower bound will be used. Unix timestamp in seconds.'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"lte"),' : optional upper bound of the range to be cleared, i.e. all messages\nolder than this will be replayed. If not present or set to "", then no upper\nbound will be used. Unix timestamp in seconds.'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"limit")," : optionally limit the number of messages replayed. This number\nrepresents a maximum value and may not be reached if there are not enough\nmessages persisted. A value of ",(0,r.kt)("inlineCode",{parentName:"li"},"-1"),", the default, means that no numerical\nlimit will be applied."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"speed")," : optionally change the speed at which the messages are replayed.\nThis can be one of the strings ",(0,r.kt)("inlineCode",{parentName:"li"},'"original"')," or ",(0,r.kt)("inlineCode",{parentName:"li"},'"fastest"'),", or a number\nindicating the factor. For example, a speed of ",(0,r.kt)("inlineCode",{parentName:"li"},"2.5")," means replay at 2.5x the\noriginal speed."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"reverse")," : optionally set to ",(0,r.kt)("inlineCode",{parentName:"li"},"true")," to play the messages in reverse order."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value.")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "replayStream",\n            "streamname": "<name of stream>",\n            "replaytopic": "<replay destination topic>",\n            "gte": <optional lower bound as unix timestamp number>,\n            "lte": <optional upper bound as unix timestamp number>,\n            "limit": <optional message limit, number>,\n            "speed": <optional replay speed, number>,\n            "reverse": <optional reverse playback mode, boolean>,\n            "correlationData": ""\n        }\n    ]\n}\n')),(0,r.kt)("h3",{id:"stopstreamreplay"},"stopStreamReplay"),(0,r.kt)("p",null,"Stop a stream replay, if it is running."),(0,r.kt)("p",null,"Parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"streamname")," : the name of the stream to be stopped."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"correlationData")," : optional string that can be used to correlate commands\nwith responses. Use a random/unique value.")),(0,r.kt)("p",null,"Command payload:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n    "commands": [\n        {\n            "command": "stopStreamReplay",\n            "streamname": "<name of stream>",\n            "correlationData": ""\n        }\n    ]\n}\n')))}c.isMDXComponent=!0},37393:function(e,t){t.Z="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTExLjk5IDJDNi40NyAyIDIgNi40OCAyIDEyczQuNDcgMTAgOS45OSAxMEMxNy41MiAyMiAyMiAxNy41MiAyMiAxMlMxNy41MiAyIDExLjk5IDJ6bTQuMjQgMTZMMTIgMTUuNDUgNy43NyAxOGwxLjEyLTQuODEtMy43My0zLjIzIDQuOTItLjQyTDEyIDVsMS45MiA0LjUzIDQuOTIuNDItMy43MyAzLjIzTDE2LjIzIDE4eiIvPjwvc3ZnPg=="}}]);